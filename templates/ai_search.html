{% extends 'base.html' %}
{% block title %}EduBrain AI - AIå®æ—¶æœé¢˜{% endblock %}

{% block head %}
<style>
    /* ç°ä»£åŒ–AIæœé¢˜é¡µé¢æ ·å¼ */
    .search-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .search-card {
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: none;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .search-card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .search-card .card-body {
        padding: 2rem;
    }

    .search-card .card-header {
        padding: 1rem 1.5rem;
        border-bottom: none;
    }

    /* è¡¨å•å…ƒç´ æ ·å¼ */
    .form-control,
    .form-select {
        border-radius: 10px;
        padding: 0.75rem 1rem;
        border: 1px solid #dee2e6;
        transition: all 0.2s ease;
        font-size: 1rem;
        background-color: #fff;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        background-color: #fff;
    }

    .form-control:hover:not(:focus) {
        border-color: #b3d7ff;
    }

    textarea.form-control {
        min-height: 120px;
        resize: vertical;
        line-height: 1.5;
    }

    /* è¾“å…¥ç»„æ ·å¼ä¼˜åŒ– */
    .input-group-text {
        border-radius: 10px 0 0 10px;
        border-color: #dee2e6;
        background-color: #f8f9fa;
        color: #6c757d;
        transition: all 0.2s ease;
    }

    .input-group .form-control {
        border-radius: 0 10px 10px 0;
    }

    .input-group:focus-within .input-group-text {
        border-color: #86b7fe;
        background-color: #e7f3ff;
        color: #0d6efd;
    }

    /* æŒ‰é’®æ ·å¼ */
    .btn-search {
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #007bff, #0056b3);
        border: none;
        color: white;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }

    .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        background: linear-gradient(135deg, #0069d9, #004494);
    }

    .btn-search:active {
        transform: translateY(0);
    }

    .btn-search:disabled {
        background: linear-gradient(135deg, #6c757d, #495057);
        box-shadow: none;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem 0;
    }

    .loading-spinner {
        width: 3rem;
        height: 3rem;
        border-width: 0.25rem;
    }

    /* ç»“æœå¡ç‰‡æ ·å¼ */
    .result-card {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-top: 2rem;
        border: none;
        transition: all 0.3s ease;
    }

    .result-card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .result-card .card-header {
        padding: 1rem 1.5rem;
        border-bottom: none;
    }

    .result-card .card-body {
        padding: 1.5rem;
    }

    /* ç­”æ¡ˆå†…å®¹æ ·å¼ */
    .answer-content {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .answer-content pre {
        background-color: #f1f3f5;
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
        white-space: pre-wrap;
    }

    .answer-content .text-success {
        font-weight: 600;
        color: #28a745 !important;
    }

    /* å†å²è®°å½•æ ·å¼ */
    .history-item {
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f8f9fa;
        border: 1px solid #eee;
        transition: all 0.2s ease;
    }

    .history-item:hover {
        background-color: #f1f3f5;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .history-item pre {
        background-color: #e9ecef;
        border-radius: 6px;
        padding: 0.5rem;
        margin: 0.25rem 0;
        font-size: 0.9rem;
    }

    .history-item .text-success {
        font-weight: 600;
    }

    /* æ ‡é¢˜æ ·å¼ */
    .page-title {
        color: #0d6efd;
        font-weight: 700;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
    }

    .page-title:after {
        content: '';
        display: block;
        width: 80px;
        height: 4px;
        background: linear-gradient(90deg, #007bff, #0056b3);
        margin: 0.5rem auto 0;
        border-radius: 2px;
    }

    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in {
        animation: fadeIn 0.5s ease forwards;
    }

    /* å¤åˆ¶æŒ‰é’®æ ·å¼ */
    .copy-btn {
        border-radius: 50px;
        padding: 0.4rem 1rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .copy-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .copy-btn i {
        margin-right: 0.25rem;
    }

    .nowrap {
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .search-container {
            max-width: 100%;
            padding: 0 1rem;
        }

        .search-card .card-body {
            padding: 1.5rem;
        }

        .btn-search {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }

        .form-control,
        .form-select {
            font-size: 0.9rem;
        }

        .page-title {
            font-size: 1.75rem;
        }
    }

    @media (max-width: 576px) {
        .search-container {
            padding: 0 0.5rem;
        }

        .search-card .card-body {
            padding: 1rem;
        }

        .d-flex.gap-2 {
            flex-direction: column;
            gap: 0.75rem !important;
        }

        .btn-search {
            width: 100%;
        }

        .page-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .history-item {
            padding: 0.75rem;
        }

        .result-card .card-body {
            padding: 1rem;
        }
    }

    /* è¡¨å•å¢å¼ºæ ·å¼ */
    .form-floating {
        position: relative;
    }

    .form-enhanced {
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .form-enhanced:focus {
        background: #ffffff;
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* åŠ è½½çŠ¶æ€ä¼˜åŒ– */
    .btn-loading {
        position: relative;
        pointer-events: none;
    }

    .btn-loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        margin: auto;
        border: 2px solid transparent;
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="search-container">
        <h1 class="text-center mb-4 page-title">AIå®æ—¶æœé¢˜</h1>
        <div class="card mb-4 search-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-search me-2"></i>è¾“å…¥é¢˜ç›®ä¿¡æ¯</h5>
            </div>
            <div class="card-body">
                <form id="aiSearchForm" onsubmit="return false;" class="needs-validation" novalidate>
                    <div class="mb-4">
                        <label for="aiQuestion" class="form-label fw-bold">
                            <i class="bi bi-pencil-square me-1"></i>é¢˜ç›®å†…å®¹
                            <span class="text-danger">*</span>
                        </label>
                        <div class="input-group has-validation">
                            <span class="input-group-text"><i class="bi bi-pencil-square"></i></span>
                            <textarea class="form-control form-enhanced" id="aiQuestion" name="title"
                                placeholder="è¯·è¾“å…¥é¢˜ç›®å†…å®¹ï¼Œæ”¯æŒå¤åˆ¶ç²˜è´´..." rows="4" required></textarea>
                            <div class="invalid-feedback">è¯·è¾“å…¥é¢˜ç›®å†…å®¹</div>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            æç¤ºï¼šç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«é¢˜ç›®ä¸­çš„é€‰é¡¹ï¼Œæ”¯æŒ Ctrl+Enter å¿«é€Ÿæœé¢˜
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="aiType" class="form-label fw-bold">
                            <i class="bi bi-list-check me-1"></i>é¢˜ç›®ç±»å‹
                        </label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-list-check"></i></span>
                            <select class="form-select form-enhanced" id="aiType" name="type">
                                <option value="">ğŸ¤– è‡ªåŠ¨è¯†åˆ«ï¼ˆæ¨èï¼‰</option>
                                <option value="single">ğŸ“ å•é€‰é¢˜</option>
                                <option value="multiple">ğŸ“‹ å¤šé€‰é¢˜</option>
                                <option value="judgement">âœ… åˆ¤æ–­é¢˜</option>
                                <option value="completion">âœï¸ å¡«ç©ºé¢˜</option>
                            </select>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-lightbulb me-1"></i>
                            ç³»ç»Ÿä¼šæ ¹æ®é¢˜ç›®å†…å®¹è‡ªåŠ¨è¯†åˆ«ç±»å‹ï¼Œä¹Ÿå¯æ‰‹åŠ¨é€‰æ‹©
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="aiOptions" class="form-label fw-bold">
                            <i class="bi bi-list-ul me-1"></i>é€‰é¡¹å†…å®¹
                            <span class="badge bg-secondary ms-2">å¯é€‰</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-list-ul"></i></span>
                            <textarea class="form-control form-enhanced" id="aiOptions" name="options" rows="3"
                                placeholder="A. é€‰é¡¹1&#10;B. é€‰é¡¹2&#10;C. é€‰é¡¹3&#10;D. é€‰é¡¹4"></textarea>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-gear me-1"></i>
                            ç³»ç»Ÿä¼šè‡ªåŠ¨ä»é¢˜ç›®ä¸­æå–é€‰é¡¹ï¼Œä¹Ÿå¯æ‰‹åŠ¨è¾“å…¥æˆ–ä¿®æ”¹
                        </div>
                    </div>

                    <div class="d-flex gap-2 mb-3 button-group">
                        <button class="btn btn-search flex-grow-1" id="aiSearchBtn" type="submit">
                            <i class="bi bi-search me-2"></i>
                            <span>AIæ™ºèƒ½æœé¢˜</span>
                        </button>
                        <button class="btn btn-info" id="batchSearchBtn" type="button" data-bs-toggle="modal"
                            data-bs-target="#batchSearchModal" title="æ‰¹é‡æœç´¢å¤šä¸ªé¢˜ç›®">
                            <i class="bi bi-stack me-1"></i>
                            <span>æ‰¹é‡</span>
                        </button>
                        <button class="btn btn-outline-secondary btn-reset" id="resetFormBtn" type="button"
                            title="æ¸…ç©ºè¡¨å•å†…å®¹">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>
                            <span>é‡ç½®</span>
                        </button>
                    </div>

                    <div class="text-center">
                        <small class="text-muted">
                            <i class="bi bi-shield-check me-1"></i>
                            AIæœé¢˜æœåŠ¡ç”±ç¬¬ä¸‰æ–¹APIæä¾›ï¼Œè¯·åˆç†ä½¿ç”¨
                        </small>
                    </div>
                </form>

                <div id="aiLoading" class="loading-container" style="display:none;">
                    <div class="d-flex flex-column align-items-center">
                        <div class="spinner-border text-primary loading-spinner mb-3" role="status">
                            <span class="visually-hidden">AIæœé¢˜ä¸­...</span>
                        </div>
                        <div class="text-center">
                            <h6 class="text-primary mb-2">
                                <i class="bi bi-robot me-2"></i>AIæ­£åœ¨åˆ†æé¢˜ç›®
                            </h6>
                            <div class="progress mb-2" style="width: 200px; height: 6px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                    style="width: 100%"></div>
                            </div>
                            <small class="text-muted">æ­£åœ¨æœç´¢æœ€ä½³ç­”æ¡ˆï¼Œè¯·ç¨å€™...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="aiResult" class="fade-in" style="display:none;">
            <div class="card result-card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-check-circle-fill me-2"></i>AIç­”æ¡ˆ</span>
                    <button class="btn btn-light btn-sm copy-btn" id="copyAnswerBtn" title="å¤åˆ¶ç­”æ¡ˆ"><i
                            class="bi bi-clipboard"></i> å¤åˆ¶</button>
                </div>
                <div class="card-body">
                    <div id="aiAnswerContent" class="answer-content"></div>
                </div>
            </div>
        </div>

        <div id="aiError" class="fade-in" style="display:none;">
            <div class="alert alert-danger mt-3 d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span id="errorMessage"></span>
            </div>
        </div>

        <div id="aiHistory" class="fade-in" style="display:none;">
            <div class="card mt-4 search-card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-clock-history me-2"></i>æœ¬é¡µAIæœé¢˜å†å²</span>
                    <button class="btn btn-light btn-sm copy-btn nowrap" id="clearHistoryBtn" title="æ¸…ç©ºå†å²"><i
                            class="bi bi-trash"></i> æ¸…ç©º</button>
                </div>
                <div class="card-body" id="aiHistoryList"></div>
            </div>
        </div>
    </div>
</div>

<!-- æ‰¹é‡æœé¢˜æ¨¡æ€æ¡† -->
<div class="modal fade" id="batchSearchModal" tabindex="-1" role="dialog" aria-labelledby="batchSearchModalLabel"
    aria-modal="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="batchSearchModalLabel">
                    <i class="bi bi-stack me-2"></i>æ‰¹é‡AIæœé¢˜
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="å…³é—­"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6 class="alert-heading">
                        <i class="bi bi-info-circle me-2"></i>æ‰¹é‡æœé¢˜è¯´æ˜ï¼š
                    </h6>
                    <ul class="mb-0">
                        <li>æ¯è¡Œè¾“å…¥ä¸€ä¸ªé¢˜ç›®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«é¢˜å‹</li>
                        <li>æ”¯æŒåŒæ—¶å¤„ç†å¤šä¸ªé¢˜ç›®ï¼Œæé«˜æœé¢˜æ•ˆç‡</li>
                        <li>ç»“æœå°†æ˜¾ç¤ºåœ¨ä¸‹æ–¹ï¼Œå¯å•ç‹¬å¤åˆ¶æ¯ä¸ªç­”æ¡ˆ</li>
                        <li>å»ºè®®æ¯æ¬¡ä¸è¶…è¿‡10ä¸ªé¢˜ç›®ï¼Œé¿å…å¤„ç†æ—¶é—´è¿‡é•¿</li>
                    </ul>
                </div>

                <form id="batchSearchForm">
                    <div class="mb-3">
                        <label for="batchQuestions" class="form-label">
                            <i class="bi bi-list-ol me-2"></i>é¢˜ç›®åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªé¢˜ç›®ï¼‰ï¼š
                        </label>
                        <textarea class="form-control" id="batchQuestions" name="questions" rows="8"
                            placeholder="è¯·è¾“å…¥é¢˜ç›®ï¼Œæ¯è¡Œä¸€ä¸ªé¢˜ç›®ï¼Œä¾‹å¦‚ï¼š&#10;1. ä¸‹åˆ—å“ªä¸ªæ˜¯æ­£ç¡®çš„ï¼Ÿ&#10;2. åˆ¤æ–­ï¼šåœ°çƒæ˜¯åœ†çš„ï¼ˆï¼‰&#10;3. å¡«ç©ºï¼šä¸­å›½çš„é¦–éƒ½æ˜¯____"></textarea>
                        <div class="form-text">
                            <span id="questionCount">0</span> ä¸ªé¢˜ç›® |
                            <span id="characterCount">0</span> ä¸ªå­—ç¬¦
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="batchDefaultType" class="form-label">é»˜è®¤é¢˜å‹ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                        <select class="form-select" id="batchDefaultType" name="defaultType">
                            <option value="">è‡ªåŠ¨è¯†åˆ«</option>
                            <option value="single">å•é€‰é¢˜</option>
                            <option value="multiple">å¤šé€‰é¢˜</option>
                            <option value="judgement">åˆ¤æ–­é¢˜</option>
                            <option value="completion">å¡«ç©ºé¢˜</option>
                        </select>
                        <div class="form-text">å¦‚æœè‡ªåŠ¨è¯†åˆ«ä¸å‡†ç¡®ï¼Œå¯ä»¥è®¾ç½®é»˜è®¤é¢˜å‹</div>
                    </div>
                </form>

                <div id="batchProgress" style="display: none;">
                    <div class="d-flex align-items-center mb-2">
                        <div class="spinner-border spinner-border-sm text-info me-2" role="status">
                            <span class="visually-hidden">å¤„ç†ä¸­...</span>
                        </div>
                        <span>æ­£åœ¨å¤„ç†ç¬¬ <span id="currentProgress">0</span> / <span id="totalProgress">0</span>
                            ä¸ªé¢˜ç›®...</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                </div>

                <div id="batchResults" style="display: none;">
                    <h6 class="mt-3 mb-2">
                        <i class="bi bi-check-circle me-2"></i>æœé¢˜ç»“æœï¼š
                    </h6>
                    <div id="batchResultsList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-info" id="startBatchSearch">
                    <i class="bi bi-play-fill me-1"></i>å¼€å§‹æ‰¹é‡æœé¢˜
                </button>
                <button type="button" class="btn btn-success" id="exportBatchResults" style="display: none;">
                    <i class="bi bi-download me-1"></i>å¯¼å‡ºç»“æœ
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
    // åˆå§‹åŒ–å†å²è®°å½•
    let aiHistory = JSON.parse(localStorage.getItem('aiSearchHistory') || '[]');

    // æ¸²æŸ“å†å²è®°å½•
    function renderHistory() {
        const list = document.getElementById('aiHistoryList');
        if (aiHistory.length === 0) {
            document.getElementById('aiHistory').style.display = 'none';
            return;
        }

        // æ˜¾ç¤ºå†å²è®°å½•å¡ç‰‡
        document.getElementById('aiHistory').style.display = '';

        // æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
        list.innerHTML = aiHistory.map((item, idx) => `
            <div class="history-item" data-index="${idx}">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-1 text-primary"><i class="bi bi-question-circle me-2"></i>é¢˜ç›®</h6>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-1 use-history-btn" data-index="${idx}" title="ä½¿ç”¨è¿™ä¸ªé¢˜ç›®">
                            <i class="bi bi-arrow-up-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-history-btn" data-index="${idx}" title="åˆ é™¤è¿™æ¡è®°å½•">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>
                <p class="mb-2">${item.question}</p>
                <div class="d-flex mb-2">
                    <span class="badge ${getTypeBadgeClass(item.type)} me-2">${getTypeDisplayName(item.type)}</span>
                    <small class="text-muted ms-auto">${item.time}</small>
                </div>
                ${item.options ? `<div class="mb-2"><strong>é€‰é¡¹ï¼š</strong><pre class="mb-1">${item.options}</pre></div>` : ''}
                <div class="mt-2 p-2 bg-light rounded">
                    <strong>ç­”æ¡ˆï¼š</strong><span class="text-success">${item.answer}</span>
                </div>
            </div>
        `).join('');

        // æ·»åŠ å†å²è®°å½•äº‹ä»¶ç›‘å¬å™¨
        document.querySelectorAll('.use-history-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const index = parseInt(this.getAttribute('data-index'));
                useHistoryItem(index);
            });
        });

        document.querySelectorAll('.delete-history-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const index = parseInt(this.getAttribute('data-index'));
                deleteHistoryItem(index);
            });
        });
    }

    // è·å–é¢˜ç›®ç±»å‹æ˜¾ç¤ºåç§°
    function getTypeDisplayName(type) {
        switch (type) {
            case 'single': return 'å•é€‰é¢˜';
            case 'multiple': return 'å¤šé€‰é¢˜';
            case 'judgement': return 'åˆ¤æ–­é¢˜';
            case 'completion': return 'å¡«ç©ºé¢˜';
            default: return 'è‡ªåŠ¨è¯†åˆ«';
        }
    }

    // è·å–é¢˜ç›®ç±»å‹å¯¹åº”çš„æ ‡ç­¾ç±»å
    function getTypeBadgeClass(type) {
        switch (type) {
            case 'single': return 'bg-success';
            case 'multiple': return 'bg-primary';
            case 'judgement': return 'bg-warning';
            case 'completion': return 'bg-info';
            default: return 'bg-secondary';
        }
    }

    // ä½¿ç”¨å†å²è®°å½•ä¸­çš„é¢˜ç›®
    function useHistoryItem(index) {
        if (index >= 0 && index < aiHistory.length) {
            const item = aiHistory[index];
            document.getElementById('aiQuestion').value = item.question;
            document.getElementById('aiType').value = item.type || '';
            document.getElementById('aiOptions').value = item.options || '';

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // é«˜äº®è¡¨å•
            const form = document.getElementById('aiSearchForm');
            form.classList.add('highlight-form');
            setTimeout(() => form.classList.remove('highlight-form'), 1500);
        }
    }

    // åˆ é™¤å†å²è®°å½•é¡¹
    function deleteHistoryItem(index) {
        if (index >= 0 && index < aiHistory.length) {
            aiHistory.splice(index, 1);
            saveHistory();
            renderHistory();
        }
    }

    // ä¿å­˜å†å²è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
    function saveHistory() {
        try {
            const historyData = JSON.stringify(aiHistory);
            localStorage.setItem('aiSearchHistory', historyData);
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                // å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œæ¸…ç†æ—§è®°å½•
                aiHistory = aiHistory.slice(0, 10); // åªä¿ç•™æœ€æ–°çš„10æ¡è®°å½•
                try {
                    localStorage.setItem('aiSearchHistory', JSON.stringify(aiHistory));
                    showToast('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå·²æ¸…ç†éƒ¨åˆ†å†å²è®°å½•', 'warning');
                } catch (e2) {
                    console.error('æ— æ³•ä¿å­˜å†å²è®°å½•:', e2);
                    showToast('æ— æ³•ä¿å­˜å†å²è®°å½•ï¼Œå­˜å‚¨ç©ºé—´ä¸è¶³', 'error');
                }
            } else {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
                showToast('ä¿å­˜å†å²è®°å½•å¤±è´¥', 'error');
            }
        }
    }

    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // è·å–é¢˜ç›®ç±»å‹æ˜¾ç¤ºåç§°
    function getTypeDisplayName(type) {
        const typeNames = {
            'single': 'å•é€‰é¢˜',
            'multiple': 'å¤šé€‰é¢˜',
            'judgement': 'åˆ¤æ–­é¢˜',
            'completion': 'å¡«ç©ºé¢˜',
            'short': 'ç®€ç­”é¢˜',
            'essay': 'è®ºè¿°é¢˜'
        };
        return typeNames[type] || type || 'æœªçŸ¥ç±»å‹';
    }

    // ç½‘ç»œçŠ¶æ€æ£€æµ‹
    function checkNetworkStatus() {
        if (!navigator.onLine) {
            showToast('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®', 'error');
            return false;
        }
        return true;
    }

    // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
    window.addEventListener('online', function () {
        showToast('ç½‘ç»œè¿æ¥å·²æ¢å¤', 'success');
    });

    window.addEventListener('offline', function () {
        showToast('ç½‘ç»œè¿æ¥å·²æ–­å¼€', 'error');
    });

    // æ¸…ç†é¢˜ç›®å‰ç¼€ï¼ˆé¢˜å·å’Œé¢˜å‹æ ‡è¯†ï¼‰
    function cleanQuestionPrefix(text) {
        if (!text) return text;

        let cleaned = text;

        // æ¸…ç†å¸¸è§çš„é¢˜å·+é¢˜å‹æ ¼å¼ï¼Œå¦‚ "3. (å•é€‰é¢˜)" æˆ– "1.ï¼ˆå¤šé€‰é¢˜ï¼‰"
        cleaned = cleaned.replace(/^\s*\d+\.?\s*[\(\uff08][^\)\uff09]*[\)\uff09]\s*/g, '');

        // æ¸…ç†åªæœ‰é¢˜å·çš„æ ¼å¼ï¼Œå¦‚ "3." æˆ– "1ã€"
        cleaned = cleaned.replace(/^\s*\d+[\.\u3001]\s*/g, '');

        // æ¸…ç†åªæœ‰é¢˜å‹çš„æ ¼å¼ï¼Œå¦‚ "(å•é€‰é¢˜)" æˆ– "ï¼ˆåˆ¤æ–­é¢˜ï¼‰"
        cleaned = cleaned.replace(/^\s*[\(\uff08][^\)\uff09]*[\)\uff09]\s*/g, '');

        // æ¸…ç†å…¶ä»–å¯èƒ½çš„å‰ç¼€æ ¼å¼
        cleaned = cleaned.replace(/^\s*[ç¬¬]\s*\d+\s*[é¢˜é“]\s*/g, '');
        cleaned = cleaned.replace(/^\s*é¢˜ç›®\s*[:ï¼š]\s*/g, '');

        return cleaned.trim();
    }

    // è‡ªåŠ¨æå–é€‰é¡¹
    function autoExtractOptions() {
        const questionInput = document.getElementById('aiQuestion');
        const optionsInput = document.getElementById('aiOptions');
        const typeSelect = document.getElementById('aiType');
        let text = questionInput.value;

        // å¦‚æœé¢˜ç›®ä¸ºç©ºï¼Œç›´æ¥è¿”å›
        if (!text.trim()) return;

        // æ˜¾ç¤ºå¤„ç†ä¸­çš„æç¤º
        showToast('æ­£åœ¨åˆ†æé¢˜ç›®...', 'info');

        // åŒ¹é…å¸¸è§çš„é€‰æ‹©é¢˜é€‰é¡¹æ ¼å¼
        // æ”¯æŒA. B. C.  Aã€Bã€Cã€  A: B: ä»¥åŠå…¨è§’
        const optionPattern = /([A-Fï¼¡-ï¼¦])[\.\u3001:\uff1a]\s*([^\n]+)/g;
        let match, options = [], indices = [];

        while ((match = optionPattern.exec(text)) !== null) {
            options.push(match[1] + '. ' + match[2].trim());
            indices.push(match.index);
        }

        if (options.length >= 2 && !optionsInput.value.trim()) {
            // è‡ªåŠ¨å¡«å……é€‰é¡¹
            optionsInput.value = options.join('\n');

            // ç§»é™¤é¢˜å¹²ä¸­çš„é€‰é¡¹éƒ¨åˆ†ï¼Œåªä¿ç•™é¢˜å¹²
            let firstOptIdx = indices[0];
            let questionText = text.slice(0, firstOptIdx).trim();

            // æ¸…ç†é¢˜ç›®å‰ç¼€
            questionText = cleanQuestionPrefix(questionText);

            questionInput.value = questionText;

            // ä½¿ç”¨å¢å¼ºçš„è‡ªåŠ¨è¯†åˆ«é¢˜ç›®ç±»å‹åŠŸèƒ½
            autoDetectQuestionType();

            // å¦‚æœè‡ªåŠ¨è¯†åˆ«å¤±è´¥ï¼Œåˆ™ä½¿ç”¨ç®€å•çš„é€‰é¡¹åˆ¤æ–­
            if (typeSelect.value === '' || typeSelect.value === 'auto') {
                // å¦‚æœé€‰é¡¹ä¸­åŒ…å«"æ­£ç¡®"æˆ–"é”™è¯¯"ï¼Œå¯èƒ½æ˜¯åˆ¤æ–­é¢˜
                const optionsText = options.join(' ').toLowerCase();
                if (optionsText.includes('æ­£ç¡®') && optionsText.includes('é”™è¯¯') && options.length === 2) {
                    typeSelect.value = 'judgement';
                } else if (text.includes('å¤šé€‰') || text.includes('å¤šé¡¹')) {
                    typeSelect.value = 'multiple';
                } else {
                    typeSelect.value = 'single';
                }
            }

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast('å·²è‡ªåŠ¨æå–é€‰é¡¹å¹¶æ¸…ç†é¢˜ç›®æ ¼å¼', 'success');
        } else {
            // å³ä½¿æ²¡æœ‰é€‰é¡¹ï¼Œä¹Ÿæ¸…ç†é¢˜ç›®å‰ç¼€
            const originalText = questionInput.value;
            const cleanedText = cleanQuestionPrefix(originalText);
            if (cleanedText !== originalText) {
                questionInput.value = cleanedText;
                showToast('å·²æ¸…ç†é¢˜ç›®æ ¼å¼', 'info');
            }
        }
    }
    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showToast(message, type = 'info') {
        // å¦‚æœå·²ç»æœ‰toastï¼Œå…ˆç§»é™¤
        const existingToast = document.getElementById('aiToast');
        if (existingToast) {
            existingToast.remove();
        }

        // åˆ›å»ºæ–°çš„toast
        const toast = document.createElement('div');
        toast.id = 'aiToast';
        toast.className = `toast-notification toast-${type}`;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : type === 'error' ? 'bi-exclamation-circle-fill' : 'bi-info-circle-fill'}"></i>
            </div>
            <div class="toast-message">${message}</div>
        `;

        document.body.appendChild(toast);

        // æ˜¾ç¤ºåè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }, 100);
    }

    // è¡¨å•éªŒè¯
    function validateForm() {
        const form = document.getElementById('aiSearchForm');
        const questionInput = document.getElementById('aiQuestion');
        const question = questionInput.value.trim();

        // æ£€æŸ¥é¢˜ç›®æ˜¯å¦ä¸ºç©º
        if (!question) {
            questionInput.classList.add('is-invalid');
            showToast('è¯·è¾“å…¥é¢˜ç›®å†…å®¹', 'error');
            return false;
        }

        // æ£€æŸ¥é¢˜ç›®é•¿åº¦
        if (question.length < 5) {
            questionInput.classList.add('is-invalid');
            showToast('é¢˜ç›®å†…å®¹å¤ªçŸ­ï¼Œè¯·è¾“å…¥å®Œæ•´çš„é¢˜ç›®', 'error');
            return false;
        }

        if (question.length > 2000) {
            questionInput.classList.add('is-invalid');
            showToast('é¢˜ç›®å†…å®¹è¿‡é•¿ï¼Œè¯·æ§åˆ¶åœ¨2000å­—ç¬¦ä»¥å†…', 'error');
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«æœ‰æ•ˆå­—ç¬¦
        if (!/[\u4e00-\u9fa5a-zA-Z0-9]/.test(question)) {
            questionInput.classList.add('is-invalid');
            showToast('é¢˜ç›®å†…å®¹æ— æ•ˆï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„é¢˜ç›®æ–‡å­—', 'error');
            return false;
        }

        // ç§»é™¤æ— æ•ˆçŠ¶æ€
        questionInput.classList.remove('is-invalid');
        questionInput.classList.add('is-valid');

        // è‡ªåŠ¨æ£€æµ‹é¢˜ç›®ç±»å‹
        autoDetectQuestionType();

        return true;
    }

    // ä¼˜åŒ–åçš„æ™ºèƒ½é¢˜å‹è¯†åˆ«
    function autoDetectQuestionType() {
        const question = document.getElementById('aiQuestion').value.trim();
        const options = document.getElementById('aiOptions').value.trim();
        const typeSelect = document.getElementById('aiType');

        // å¦‚æœç”¨æˆ·å·²ç»é€‰æ‹©äº†ç±»å‹ä¸”ä¸æ˜¯ç©ºå€¼ï¼Œä¸è¦†ç›–
        if (typeSelect.value !== '' && typeSelect.value !== 'auto') return;

        let detectedType = '';
        let confidence = 0;

        // ç®€åŒ–çš„é¢˜å‹è¯†åˆ«æ¨¡å¼
        const patterns = {
            'judgement': {
                regex: /[åˆ¤æ–­å¯¹é”™æ˜¯å¦æ­£ç¡®é”™è¯¯].*[\(\uff08].*[\)\uff09]$|[å¯¹é”™âˆšÃ—TF][\(\uff08].*[\)\uff09]/i,
                keywords: ['åˆ¤æ–­', 'å¯¹é”™', 'æ˜¯å¦æ­£ç¡®', 'æ­£ç¡®', 'é”™è¯¯'],
                weight: 0.9
            },
            'single': {
                regex: /[A-F][\.ã€ï¼š:]\s*[^\n]+.*[A-F][\.ã€ï¼š:]\s*[^\n]+/g,
                keywords: ['å•é€‰', 'é€‰æ‹©ä¸€ä¸ª', 'ä¸‹åˆ—å“ªä¸ª'],
                weight: 0.8
            },
            'multiple': {
                regex: /[A-F][\.ã€ï¼š:]\s*[^\n]+.*[A-F][\.ã€ï¼š:]\s*[^\n]+.*[A-F][\.ã€ï¼š:]\s*[^\n]+/g,
                keywords: ['å¤šé€‰', 'é€‰æ‹©å¤šä¸ª', 'ä¸‹åˆ—å“ªäº›'],
                weight: 0.8
            },
            'completion': {
                regex: /[å¡«å†™è¡¥å……å›ç­”]|_{2,}|\[\s*\]|\(\s*\)|è¯·.*å†™å‡º|è¯·.*å¡«å…¥/,
                keywords: ['å¡«ç©º', 'å¡«å†™', 'è¡¥å……', 'å®Œæˆ'],
                weight: 0.7
            }
        };

        // æ£€æŸ¥é€‰é¡¹å†…å®¹
        const hasOptions = options.trim().length > 0;
        const optionCount = hasOptions ? options.split(/[A-F][\.ã€ï¼š:]/).length - 1 : 0;

        // å¤šé€‰é¢˜ç‰¹å¾
        const multipleChoiceKeywords = [
            'å¤šé€‰', 'å¤šé¡¹', 'å¤šä¸ª', 'å¤šç§', 'å¤šé¡¹é€‰æ‹©', 'é€‰å‡ºå¤šä¸ª',
            'ä¸‹åˆ—é€‰é¡¹ä¸­', 'ä»¥ä¸‹é€‰é¡¹ä¸­', 'é€‰å‡ºæ­£ç¡®çš„é€‰é¡¹', 'é€‰å‡ºæ­£ç¡®çš„é€‰é¡¹æœ‰',
            'é€‰å‡ºæ­£ç¡®çš„æ˜¯', 'é€‰æ‹©æ­£ç¡®çš„é€‰é¡¹æœ‰', 'é€‰æ‹©æ­£ç¡®çš„æœ‰', 'ç¬¦åˆé¢˜æ„çš„æœ‰'
        ];
        const hasMultipleKeyword = multipleChoiceKeywords.some(keyword => question.includes(keyword));

        // å•é€‰é¢˜ç‰¹å¾
        const singleChoiceKeywords = [
            'å•é€‰', 'é€‰å‡ºå”¯ä¸€', 'é€‰å‡ºæœ€ä½³', 'é€‰å‡ºæœ€ä½³ç­”æ¡ˆ', 'é€‰å‡ºæœ€ä½³é€‰é¡¹',
            'é€‰å‡ºæ­£ç¡®çš„ä¸€é¡¹', 'é€‰å‡ºæ­£ç¡®çš„é€‰é¡¹', 'é€‰æ‹©æ­£ç¡®çš„ä¸€é¡¹', 'é€‰æ‹©æ­£ç¡®çš„é€‰é¡¹'
        ];
        const hasSingleKeyword = singleChoiceKeywords.some(keyword => question.includes(keyword));

        // æ£€æµ‹é€‰é¡¹æ•°é‡ç‰¹å¾
        const optionsCount = options ? options.split('\n').filter(line => line.trim()).length : 0;
        const hasMultipleOptions = optionsCount >= 4; // é€‰é¡¹æ•°é‡è¾ƒå¤šæ—¶å¯èƒ½æ˜¯å¤šé€‰é¢˜

        // æ£€æµ‹é€‰é¡¹å†…å®¹ç‰¹å¾
        const optionsText = options || '';
        const hasMultipleCorrectPattern = optionsText.includes('æ­£ç¡®çš„æœ‰') ||
            optionsText.includes('æ­£ç¡®çš„æ˜¯') ||
            optionsText.includes('æ­£ç¡®çš„æœ‰') ||
            /[A-D][,ï¼Œ][A-D]/.test(optionsText) ||
            /é€‰æ‹©.*?å¤šä¸ª/.test(question);

        // å¡«ç©ºé¢˜ç‰¹å¾
        const completionKeywords = ['å¡«ç©º', 'è¡¥å……', 'å¡«å†™', 'å¡«å…¥', 'è¡¥å…¨'];
        const hasCompletionKeyword = completionKeywords.some(keyword => question.includes(keyword));

        // é€‰æ‹©é¢˜ä¸­çš„æ‹¬å·æ¨¡å¼ï¼Œå¦‚â€œé€‰æ‹©æ­£ç¡®çš„é€‰é¡¹()â€
        const choiceWithBracketPattern = /\([\s_]*\)|\uff08[\s_]*\uff09/.test(question) && /[A-D]/.test(question + options);

        // æ£€æµ‹å¥ä¸­æ‹¬å·å’Œå¥å°¾æ‹¬å·
        const hasMidBrackets = /[^\s\.\u3002\uff0c\,\;\uff1b]\s*[\(\uff08]\s*[\)\uff09]\s*[^\s\.\u3002\uff0c\,\;\uff1b]/.test(question);
        const hasEndBrackets = /[^\s\.\u3002\uff0c\,\;\uff1b]\s*[\(\uff08]\s*[\)\uff09]\s*[\.\u3002\uff0c\,\;\uff1b\s]*$/.test(question);

        // æ£€æµ‹æ˜¯å¦æ˜¯å®Œæ•´é™ˆè¿°å¥ï¼ˆåˆ¤æ–­é¢˜ç‰¹å¾ï¼‰
        const isCompleteStatement = /^[^\?\?ï¼Ÿ]+[\.\u3002]\s*[\(\uff08]\s*[\)\uff09]\s*$/.test(question.trim());

        // æ£€æµ‹æ˜¯å¦æ˜¯ä¸å®Œæ•´å¥å­ï¼ˆå¡«ç©ºé¢˜ç‰¹å¾ï¼‰
        const isIncompleteStatement = !isCompleteStatement && /[\(\uff08]\s*[\)\uff09]/.test(question);

        // æ£€æµ‹æ˜¯å¦æ˜¯â€œè¯·å¡«å†™â€ç±»å‹çš„æç¤ºè¯­
        const hasCompletionPrompt = /(è¯·å¡«å†™|è¯·å¡«ç©º|è¯·è¡¥å……|è¯·å›ç­”|è¯·å†™å‡º|è¯·å†™å‡º|è¯·æŒ‡å‡º|è¯·åˆ—ä¸¾)/.test(question);

        // å¡«ç©ºé¢˜ä¸­çš„ç©ºç™½æ¨¡å¼
        const hasBlankPattern = /_{2,}|\.\.\.|â€¦+|\[\s*\]/.test(question) || isIncompleteStatement;

        // åˆ¤æ–­é¢˜ç‰¹å¾ - å®Œæ•´é™ˆè¿°å¥åŠ å¥å°¾æ‹¬å·
        const hasJudgementBracketPattern = isCompleteStatement && hasEndBrackets && !hasMidBrackets;

        // åŸºäºå¥å­ç»“æ„åˆ¤æ–­é¢˜å‹
        // åˆ¤æ–­é¢˜é€šå¸¸æ˜¯é™ˆè¿°å¥ï¼Œä»¥å¥å·æˆ–å¥å·åŠ ç©ºæ ¼ç»“å°¾
        const isStatementSentence = /[^\?\?ï¼Ÿ][\.\u3002\uff0c\,\;\uff1b]\s*$/.test(question.trim()) ||
            /[^\?\?ï¼Ÿ]\s*[\(\uff08]\s*[\)\uff09]\s*$/.test(question.trim());
        // å¡«ç©ºé¢˜é€šå¸¸æ˜¯é—®å¥æˆ–ä¸å®Œæ•´å¥å­
        const isQuestionSentence = /[\?\?ï¼Ÿ]\s*$/.test(question.trim());

        // åˆ¤æ–­æ˜¯å¦æ˜¯é™ˆè¿°æŸä¸ªè§‚ç‚¹çš„å¥å­ï¼ˆå…¸å‹çš„åˆ¤æ–­é¢˜ç‰¹å¾ï¼‰
        const isOpinionStatement = /(è®¤ä¸º|è¡¨æ˜|è¯´æ˜|æŒ‡å‡º|æè¿°|å±äº|å°±æ˜¯|åº”è¯¥|å¿…é¡»|å¯ä»¥|ä¸èƒ½|ä¸åº”è¯¥)/.test(question);

        // åˆ¤æ–­é¢˜ç›®ç±»å‹ï¼ˆä¼˜å…ˆçº§é¡ºåºè°ƒæ•´ï¼‰
        if (options.trim().length > 0 || choiceWithBracketPattern) {
            // æœ‰é€‰é¡¹æˆ–é€‰æ‹©é¢˜æ‹¬å·æ¨¡å¼æ—¶ï¼Œä¼˜å…ˆåˆ¤æ–­ä¸ºé€‰æ‹©é¢˜
            if (hasJudgementKeyword && (options.includes('æ­£ç¡®') && options.includes('é”™è¯¯'))) {
                detectedType = 'judgement';
            } else if (hasMultipleKeyword || hasMultipleCorrectPattern ||
                (hasMultipleOptions && !hasSingleKeyword)) {
                // å¦‚æœæœ‰å¤šé€‰å…³é”®è¯æˆ–å¤šé€‰æ¨¡å¼ï¼Œæˆ–è€…é€‰é¡¹å¤šä¸”æ²¡æœ‰å•é€‰å…³é”®è¯
                detectedType = 'multiple';
            } else if (hasSingleKeyword ||
                (optionsCount > 0 && optionsCount <= 4 && !hasMultipleKeyword && !hasMultipleCorrectPattern)) {
                // å¦‚æœæœ‰å•é€‰å…³é”®è¯æˆ–è€…é€‰é¡¹æ•°é‡é€‚ä¸­ä¸”æ²¡æœ‰å¤šé€‰ç‰¹å¾
                detectedType = 'single';
            } else {
                // é»˜è®¤ä¸ºå•é€‰é¢˜
                detectedType = 'single';
            }
        } else if (hasCompletionPrompt || hasCompletionKeyword || isIncompleteStatement || hasMidBrackets || isQuestionSentence) {
            // å¡«ç©ºé¢˜æç¤ºè¯­æˆ–å…³é”®è¯æˆ–ä¸å®Œæ•´å¥å­æˆ–å¥ä¸­æ‹¬å·æˆ–é—®å¥
            detectedType = 'completion';
        } else if (hasJudgementKeyword || (isCompleteStatement && hasEndBrackets) || (isStatementSentence && isOpinionStatement)) {
            // åˆ¤æ–­é¢˜å…³é”®è¯æˆ–å®Œæ•´é™ˆè¿°å¥åŠ å¥å°¾æ‹¬å·æˆ–æ˜¯é™ˆè¿°è§‚ç‚¹çš„é™ˆè¿°å¥
            detectedType = 'judgement';
        } else if (hasSingleChoicePattern) {
            // å…¶ä»–é€‰æ‹©é¢˜ç‰¹å¾
            detectedType = 'single';
        } else if (isStatementSentence) {
            // å¦‚æœæ˜¯é™ˆè¿°å¥ä½†æ²¡æœ‰å…¶ä»–æ˜æ˜¾ç‰¹å¾ï¼Œåˆ™å¯èƒ½æ˜¯åˆ¤æ–­é¢˜
            detectedType = 'judgement';
        } else {
            // é»˜è®¤ä¸ºå¡«ç©ºé¢˜
            detectedType = 'completion';
        }

        // è®¾ç½®æ£€æµ‹åˆ°çš„ç±»å‹å¹¶æ˜¾ç¤ºç½®ä¿¡åº¦
        if (detectedType) {
            typeSelect.value = detectedType;
            console.log(`æ™ºèƒ½è¯†åˆ«é¢˜ç›®ç±»å‹: ${detectedType}`);

            // æ˜¾ç¤ºè¯†åˆ«ç»“æœæç¤º
            showTypeDetectionHint(detectedType);
        }
    }

    // æ˜¾ç¤ºé¢˜å‹è¯†åˆ«æç¤º
    function showTypeDetectionHint(type) {
        const typeNames = {
            'single': 'å•é€‰é¢˜',
            'multiple': 'å¤šé€‰é¢˜',
            'judgement': 'åˆ¤æ–­é¢˜',
            'completion': 'å¡«ç©ºé¢˜'
        };

        const hint = document.createElement('div');
        hint.className = 'alert alert-info alert-dismissible fade show mt-2';
        hint.innerHTML = `
            <i class="bi bi-lightbulb me-2"></i>
            æ™ºèƒ½è¯†åˆ«ä¸ºï¼š<strong>${typeNames[type]}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // ç§»é™¤ä¹‹å‰çš„æç¤º
        const existingHint = document.querySelector('.type-detection-hint');
        if (existingHint) existingHint.remove();

        hint.classList.add('type-detection-hint');
        document.getElementById('aiType').parentNode.appendChild(hint);

        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            if (hint.parentNode) {
                hint.classList.remove('show');
                setTimeout(() => hint.remove(), 150);
            }
        }, 3000);
    }

    // åˆå¹¶çš„é¢˜ç›®è¾“å…¥æ¡†äº‹ä»¶å¤„ç†
    const questionInput = document.getElementById('aiQuestion');

    // å®æ—¶è¾“å…¥éªŒè¯å’Œå­—ç¬¦è®¡æ•°ï¼ˆåˆå¹¶ä¸ºä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼‰
    questionInput.addEventListener('input', function () {
        // è¾“å…¥éªŒè¯
        if (this.value.trim()) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
        }

        // å­—ç¬¦è®¡æ•°
        const maxLength = 2000;
        const currentLength = this.value.length;
        const remaining = maxLength - currentLength;

        // åˆ›å»ºæˆ–æ›´æ–°å­—ç¬¦è®¡æ•°æ˜¾ç¤º
        let counter = document.getElementById('questionCounter');
        if (!counter) {
            counter = document.createElement('small');
            counter.id = 'questionCounter';
            counter.className = 'text-muted float-end';
            this.parentNode.parentNode.appendChild(counter);
        }

        counter.textContent = `${currentLength}/${maxLength} å­—ç¬¦`;

        if (remaining < 100) {
            counter.className = 'text-warning float-end';
        } else if (remaining < 0) {
            counter.className = 'text-danger float-end';
        } else {
            counter.className = 'text-muted float-end';
        }

        // è¡¨å•éªŒè¯
        validateForm();
    });

    // é¢˜ç›®è¾“å…¥æ¡†ç²˜è´´äº‹ä»¶ - è‡ªåŠ¨è¯†åˆ«é¢˜ç›®ç±»å‹å’Œé€‰é¡¹ï¼Œä½†ä¸è‡ªåŠ¨æœé¢˜
    questionInput.addEventListener('paste', function (e) {
        // ç­‰å¾…ç²˜è´´å†…å®¹å®Œæˆ
        setTimeout(function () {
            const questionText = document.getElementById('aiQuestion').value.trim();

            // å¦‚æœç²˜è´´çš„å†…å®¹ä¸ä¸ºç©ºä¸”é•¿åº¦è¶³å¤Ÿ
            if (questionText && questionText.length > 5) {
                // è‡ªåŠ¨æå–é€‰é¡¹
                autoExtractOptions();
                // è‡ªåŠ¨è¯†åˆ«é¢˜ç›®ç±»å‹
                autoDetectQuestionType();

                // æ˜¾ç¤ºæç¤º
                const type = document.getElementById('aiType').value;
                let typeText = getTypeDisplayName(type);

                showToast(`å·²è‡ªåŠ¨è¯†åˆ«é¢˜ç›®ç±»å‹: ${typeText}`, 'info');
                showToast('è¯·ç‚¹å‡»æœç´¢æŒ‰é’®è¿›è¡Œæœé¢˜', 'info');
            }
        }, 100);
    });

    // å¤±å»ç„¦ç‚¹æ—¶è‡ªåŠ¨æå–é€‰é¡¹ï¼ˆä½¿ç”¨é˜²æŠ–ï¼‰
    const debouncedAutoExtract = debounce(autoExtractOptions, 500);
    questionInput.addEventListener('blur', debouncedAutoExtract);

    // æ¸…ç©ºå†å²è®°å½• - ç›´æ¥æ¸…ç©ºä¸éœ€è¦ç¡®è®¤
    document.getElementById('clearHistoryBtn').addEventListener('click', function () {
        aiHistory = [];
        saveHistory();
        renderHistory();
        showToast('å†å²è®°å½•å·²æ¸…ç©º', 'success');
    });

    // æœé¢˜è¡¨å•æäº¤
    document.getElementById('aiSearchForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        // éªŒè¯è¡¨å•
        if (!validateForm()) {
            showToast('è¯·è¾“å…¥é¢˜ç›®å†…å®¹', 'error');
            return;
        }

        // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
        if (!checkNetworkStatus()) {
            return;
        }

        // è®°å½•ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨é€‰æ‹©äº†é¢˜ç›®ç±»å‹
        const currentType = document.getElementById('aiType').value;
        const userManuallySelected = currentType && currentType !== '' && currentType !== 'auto';

        // è‡ªåŠ¨æå–é€‰é¡¹
        autoExtractOptions();

        // åªæœ‰åœ¨ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨é€‰æ‹©é¢˜ç›®ç±»å‹æ—¶æ‰è‡ªåŠ¨è¯†åˆ«
        if (!userManuallySelected) {
            autoDetectQuestionType();
        }

        // éšè—ä¹‹å‰çš„ç»“æœ
        document.getElementById('aiResult').style.display = 'none';
        document.getElementById('aiError').style.display = 'none';
        document.getElementById('aiLoading').style.display = 'flex';

        // æ·»åŠ åŠ è½½è¿›åº¦æ¨¡æ‹Ÿ
        let loadingProgress = 0;
        const progressBar = document.querySelector('#aiLoading .progress-bar');
        const loadingInterval = setInterval(() => {
            loadingProgress += Math.random() * 15;
            if (loadingProgress > 90) loadingProgress = 90;
            if (progressBar) {
                progressBar.style.width = loadingProgress + '%';
            }
        }, 200);

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const btn = document.getElementById('aiSearchBtn');
        btn.disabled = true;
        btn.classList.add('btn-loading');
        btn.innerHTML = '<span class="me-2">AIæœé¢˜ä¸­...</span>';

        // è·å–è¡¨å•æ•°æ®
        const title = document.getElementById('aiQuestion').value.trim();
        let type = document.getElementById('aiType').value;
        const options = document.getElementById('aiOptions').value.trim();

        // åªæœ‰åœ¨ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨é€‰æ‹©é¢˜ç›®ç±»å‹æ—¶æ‰è¿›è¡Œè‡ªåŠ¨æ£€æµ‹
        if (!type || type === '' || type === 'auto') {
            // å¼ºåˆ¶é€‰é¡¹æ£€æµ‹é€»è¾‘ï¼Œç¡®ä¿æœ‰é€‰é¡¹æ—¶è¯†åˆ«ä¸ºé€‰æ‹©é¢˜
            if (options.trim().length > 0) {
                // ä¼˜å…ˆæ£€æŸ¥é€‰é¡¹å†…å®¹
                if (options.includes('æ­£ç¡®') && options.includes('é”™è¯¯') && options.split('\n').length <= 2) {
                    type = 'judgement';
                } else if (title.includes('å¤šé€‰') || title.includes('å¤šé¡¹') ||
                    title.includes('å¤šé¡¹é€‰æ‹©') || title.includes('å¤šé€‰é¢˜')) {
                    type = 'multiple';
                } else {
                    // é»˜è®¤ä¸ºå•é€‰é¢˜
                    type = 'single';
                }
            } else {
                // æ²¡æœ‰é€‰é¡¹æ—¶çš„åˆ¤æ–­é€»è¾‘
                if (title.includes('åˆ¤æ–­') || title.includes('å¯¹é”™') ||
                    title.includes('æ˜¯å¦') || title.includes('æ­£è¯¯')) {
                    type = 'judgement';
                } else if (title.includes('å¡«ç©º') || title.includes('è¡¥å……') ||
                    title.includes('å¡«å†™') || /_{2,}|\.\.\.|â€¦+|\[\s*\]|ï¼ˆ\s*ï¼‰|\(\s*\)/g.test(title)) {
                    type = 'completion';
                } else {
                    // å¦‚æœæ²¡æœ‰æ˜æ˜¾ç‰¹å¾ï¼Œé»˜è®¤ä¸ºå¡«ç©ºé¢˜
                    type = 'completion';
                }
            }
        }

        // è®¾ç½®é¢˜ç›®ç±»å‹å¹¶è®°å½•
        document.getElementById('aiType').value = type;
        console.log(`è¡¨å•æäº¤å‰è®¾ç½®é¢˜ç›®ç±»å‹: ${type}`);

        // æ˜¾ç¤ºé¢˜ç›®ç±»å‹æç¤ºï¼ˆé¿å…Jinja2è¯­æ³•å†²çªï¼‰
        let typeText = '';
        if (type === 'single') typeText = 'å•é€‰é¢˜';
        else if (type === 'multiple') typeText = 'å¤šé€‰é¢˜';
        else if (type === 'judgement') typeText = 'åˆ¤æ–­é¢˜';
        else if (type === 'completion') typeText = 'å¡«ç©ºé¢˜';
        else typeText = type;

        showToast(`é¢˜ç›®ç±»å‹: ${typeText}`, 'info');

        try {
            // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶

            // å‘é€è¯·æ±‚
            const resp = await fetch('/api/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, type, options }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            const data = await resp.json();

            if (data.code === 1) {
                // æ¸²æŸ“ç­”æ¡ˆ
                document.getElementById('aiAnswerContent').innerHTML = `
                    <div class='mb-3'>
                        <h6 class="text-primary mb-2"><i class="bi bi-question-circle me-2"></i>é¢˜ç›®</h6>
                        <p>${data.question}</p>
                    </div>
                    ${options ? `
                    <div class='mb-3'>
                        <h6 class="text-primary mb-2"><i class="bi bi-list-ul me-2"></i>é€‰é¡¹</h6>
                        <pre class='mb-1 p-2 bg-light rounded'>${options}</pre>
                    </div>` : ''}
                    <div class='mb-3'>
                        <h6 class="text-success mb-2"><i class="bi bi-check-circle me-2"></i>ç­”æ¡ˆ</h6>
                        <div class='p-3 bg-light rounded'>
                            <span class='text-success fw-bold'>${data.answer}</span>
                        </div>
                    </div>
                `;

                // æ˜¾ç¤ºç»“æœå¹¶æ·»åŠ åŠ¨ç”»
                const resultElement = document.getElementById('aiResult');
                resultElement.style.display = 'block';
                resultElement.classList.add('fade-in');

                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                setTimeout(() => {
                    resultElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);

                // ä¿å­˜å†å²
                const historyItem = {
                    question: data.question,
                    type: type,
                    options: options,
                    answer: data.answer,
                    time: new Date().toLocaleString()
                };

                aiHistory.unshift(historyItem);
                if (aiHistory.length > 20) aiHistory.length = 20; // æœ€å¤šä¿å­˜20æ¡è®°å½•
                saveHistory();
                renderHistory();

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showToast('æœé¢˜æˆåŠŸ', 'success');
            } else {
                // æ˜¾ç¤ºé”™è¯¯
                document.getElementById('errorMessage').textContent = data.msg || 'AIæœªèƒ½è¿”å›ç­”æ¡ˆ';
                document.getElementById('aiError').style.display = 'block';
                document.getElementById('aiError').classList.add('fade-in');
                showToast('æœé¢˜å¤±è´¥', 'error');
            }
        } catch (e) {
            // å¤„ç†å¼‚å¸¸
            let errorMsg = 'è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•';

            // æ ¹æ®é”™è¯¯ç±»å‹æä¾›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
            if (e.name === 'AbortError') {
                errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥';
            } else if (e.name === 'TypeError') {
                errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥';
            } else if (e.message) {
                errorMsg = e.message;
            }

            document.getElementById('errorMessage').textContent = errorMsg;
            document.getElementById('aiError').style.display = 'block';
            document.getElementById('aiError').classList.add('fade-in');
            showToast('æœé¢˜å¤±è´¥: ' + errorMsg, 'error');
            console.error('AIæœé¢˜é”™è¯¯:', e);
        } finally {
            // æ¸…ç†åŠ è½½è¿›åº¦
            if (typeof loadingInterval !== 'undefined') {
                clearInterval(loadingInterval);
            }
            const progressBar = document.querySelector('#aiLoading .progress-bar');
            if (progressBar) {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressBar.style.width = '0%';
                }, 200);
            }

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            btn.disabled = false;
            btn.classList.remove('btn-loading');
            btn.innerHTML = '<i class="bi bi-search me-2"></i>AIæœé¢˜';
            document.getElementById('aiLoading').style.display = 'none';

            // æœç´¢å®Œæˆåçš„å¤„ç†
            setTimeout(() => {
                // å¦‚æœæˆåŠŸæ˜¾ç¤ºäº†ç»“æœï¼Œåˆ™æç¤ºç”¨æˆ·
                if (document.getElementById('aiResult').style.display !== 'none') {
                    showToast('æœé¢˜å®Œæˆï¼è¡¨å•å°†åœ¨3ç§’åè‡ªåŠ¨é‡ç½®', 'success');

                    // å»¶è¿Ÿé‡ç½®è¡¨å•ï¼Œç»™ç”¨æˆ·æ—¶é—´æŸ¥çœ‹ç»“æœ
                    setTimeout(() => {
                        resetSearchFormSilently();
                        showToast('è¡¨å•å·²é‡ç½®ï¼Œå¯ä»¥è¾“å…¥æ–°é¢˜ç›®', 'info');
                    }, 3000);
                }
            }, 500);
        }
    });

    // å¤åˆ¶ç­”æ¡ˆæŒ‰é’®
    document.getElementById('copyAnswerBtn').onclick = function () {
        const answerText = document.getElementById('aiAnswerContent').innerText;
        navigator.clipboard.writeText(answerText).then(() => {
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬å’Œå›¾æ ‡
            this.innerHTML = '<i class="bi bi-check-circle"></i> å·²å¤åˆ¶';
            this.classList.add('btn-success');
            this.classList.remove('btn-light');

            // æ˜¾ç¤ºæç¤º
            showToast('ç­”æ¡ˆå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                this.innerHTML = '<i class="bi bi-clipboard"></i> å¤åˆ¶';
                this.classList.remove('btn-success');
                this.classList.add('btn-light');
            }, 1500);
        }).catch(err => {
            showToast('å¤åˆ¶å¤±è´¥: ' + err, 'error');
        });
    };

    // é¡µé¢åŠ è½½å®Œæˆåæ¸²æŸ“å†å²è®°å½•
    document.addEventListener('DOMContentLoaded', function () {
        renderHistory();

        // æ·»åŠ æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .toast-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                display: flex;
                align-items: center;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                transform: translateY(-20px);
                opacity: 0;
                transition: all 0.3s ease;
                max-width: 350px;
            }

            .toast-notification.show {
                transform: translateY(0);
                opacity: 1;
            }

            .toast-success {
                background-color: #d4edda;
                border-left: 4px solid #28a745;
                color: #155724;
            }

            .toast-error {
                background-color: #f8d7da;
                border-left: 4px solid #dc3545;
                color: #721c24;
            }

            .toast-info {
                background-color: #d1ecf1;
                border-left: 4px solid #17a2b8;
                color: #0c5460;
            }

            .toast-icon {
                margin-right: 12px;
                font-size: 1.25rem;
            }

            .toast-message {
                font-size: 0.9rem;
                font-weight: 500;
            }

            .highlight-form {
                animation: highlight-pulse 1.5s ease;
            }

            @keyframes highlight-pulse {
                0% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.5); }
                70% { box-shadow: 0 0 0 10px rgba(13, 110, 253, 0); }
                100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
            }
        `;
        document.head.appendChild(style);
    });

    // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', function (e) {
        // Ctrl+Enter æäº¤è¡¨å•
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('aiSearchBtn').click();
        }
        // Ctrl+R é‡ç½®è¡¨å•
        else if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            resetSearchForm();
        }
        // Escape æ¸…é™¤é”™è¯¯ä¿¡æ¯
        else if (e.key === 'Escape') {
            document.getElementById('aiError').style.display = 'none';
            document.getElementById('aiResult').style.display = 'none';
        }
        // F1 æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
        else if (e.key === 'F1') {
            e.preventDefault();
            showToast('å¿«æ·é”®ï¼šCtrl+Enter æœé¢˜ï¼ŒCtrl+R é‡ç½®ï¼ŒEsc æ¸…é™¤ç»“æœ', 'info');
        }
    });

    // é‡ç½®è¡¨å•å‡½æ•°
    function resetSearchForm() {
        // æ¸…ç©ºé¢˜ç›®å’Œé€‰é¡¹
        document.getElementById('aiQuestion').value = '';
        document.getElementById('aiOptions').value = '';

        // é‡ç½®é¢˜ç›®ç±»å‹ä¸ºè‡ªåŠ¨è¯†åˆ«
        document.getElementById('aiType').value = '';

        // ç§»é™¤éªŒè¯çŠ¶æ€ç±»
        document.getElementById('aiQuestion').classList.remove('is-valid', 'is-invalid');

        // éšè—ç»“æœå’Œé”™è¯¯åŒºåŸŸ
        document.getElementById('aiResult').style.display = 'none';
        document.getElementById('aiError').style.display = 'none';

        // èšç„¦åˆ°é¢˜ç›®è¾“å…¥æ¡†
        document.getElementById('aiQuestion').focus();

        // æ˜¾ç¤ºæç¤º
        showToast('è¡¨å•å·²é‡ç½®', 'info');
    }

    // é™é»˜é‡ç½®è¡¨å•å‡½æ•°ï¼ˆä¸æ˜¾ç¤ºæç¤ºï¼‰
    function resetSearchFormSilently() {
        // æ¸…ç©ºé¢˜ç›®å’Œé€‰é¡¹
        document.getElementById('aiQuestion').value = '';
        document.getElementById('aiOptions').value = '';

        // é‡ç½®é¢˜ç›®ç±»å‹ä¸ºè‡ªåŠ¨è¯†åˆ«
        document.getElementById('aiType').value = '';

        // ç§»é™¤éªŒè¯çŠ¶æ€ç±»
        document.getElementById('aiQuestion').classList.remove('is-valid', 'is-invalid');

        // èšç„¦åˆ°é¢˜ç›®è¾“å…¥æ¡†
        document.getElementById('aiQuestion').focus();
    }

    // é‡ç½®æŒ‰é’®äº‹ä»¶
    document.getElementById('resetFormBtn').addEventListener('click', resetSearchForm);

    // æ‰¹é‡æœé¢˜åŠŸèƒ½
    let batchResults = [];

    // æ‰¹é‡æœé¢˜å­—ç¬¦è®¡æ•°
    document.getElementById('batchQuestions').addEventListener('input', function () {
        const text = this.value;
        const lines = text.split('\n').filter(line => line.trim().length > 0);
        document.getElementById('questionCount').textContent = lines.length;
        document.getElementById('characterCount').textContent = text.length;
    });

    // å¼€å§‹æ‰¹é‡æœé¢˜
    document.getElementById('startBatchSearch').addEventListener('click', async function () {
        const questionsText = document.getElementById('batchQuestions').value.trim();
        const defaultType = document.getElementById('batchDefaultType').value;

        if (!questionsText) {
            showToast('è¯·è¾“å…¥é¢˜ç›®å†…å®¹', 'error');
            return;
        }

        const questions = questionsText.split('\n').filter(line => line.trim().length > 0);

        if (questions.length === 0) {
            showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é¢˜ç›®', 'error');
            return;
        }

        if (questions.length > 10) {
            if (!confirm('é¢˜ç›®æ•°é‡è¾ƒå¤šï¼Œå¤„ç†æ—¶é—´å¯èƒ½è¾ƒé•¿ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                return;
            }
        }

        // å¼€å§‹æ‰¹é‡å¤„ç†
        await processBatchSearch(questions, defaultType);
    });

    // å¤„ç†æ‰¹é‡æœé¢˜
    async function processBatchSearch(questions, defaultType) {
        const startBtn = document.getElementById('startBatchSearch');
        const progressDiv = document.getElementById('batchProgress');
        const resultsDiv = document.getElementById('batchResults');
        const resultsList = document.getElementById('batchResultsList');
        const exportBtn = document.getElementById('exportBatchResults');

        // é‡ç½®çŠ¶æ€
        batchResults = [];
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>å¤„ç†ä¸­...';
        progressDiv.style.display = 'block';
        resultsDiv.style.display = 'none';
        exportBtn.style.display = 'none';

        const totalQuestions = questions.length;
        document.getElementById('totalProgress').textContent = totalQuestions;

        try {
            for (let i = 0; i < questions.length; i++) {
                const question = questions[i].trim();
                document.getElementById('currentProgress').textContent = i + 1;

                // æ›´æ–°è¿›åº¦æ¡
                const progress = ((i + 1) / totalQuestions) * 100;
                document.getElementById('progressBar').style.width = progress + '%';

                try {
                    // æ¸…ç†é¢˜ç›®å‰ç¼€
                    const cleanedQuestion = cleanQuestionPrefix(question);

                    // è°ƒç”¨æœé¢˜API
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            title: cleanedQuestion,
                            type: defaultType || 'auto',
                            options: ''
                        })
                    });

                    const data = await response.json();

                    batchResults.push({
                        index: i + 1,
                        originalQuestion: question,
                        cleanedQuestion: cleanedQuestion,
                        type: data.type || defaultType || 'auto',
                        answer: data.answer || 'æœªæ‰¾åˆ°ç­”æ¡ˆ',
                        success: data.code === 1,
                        error: data.code !== 1 ? data.msg : null
                    });

                } catch (error) {
                    console.error(`é¢˜ç›® ${i + 1} å¤„ç†å¤±è´¥:`, error);
                    batchResults.push({
                        index: i + 1,
                        originalQuestion: question,
                        cleanedQuestion: question,
                        type: defaultType || 'auto',
                        answer: 'å¤„ç†å¤±è´¥',
                        success: false,
                        error: error.message
                    });
                }

                // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                if (i < questions.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            // æ˜¾ç¤ºç»“æœ
            displayBatchResults();

        } catch (error) {
            console.error('æ‰¹é‡æœé¢˜å¤±è´¥:', error);
            showToast('æ‰¹é‡æœé¢˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="bi bi-play-fill me-1"></i>å¼€å§‹æ‰¹é‡æœé¢˜';
            progressDiv.style.display = 'none';
        }
    }

    // æ˜¾ç¤ºæ‰¹é‡æœé¢˜ç»“æœ
    function displayBatchResults() {
        const resultsDiv = document.getElementById('batchResults');
        const resultsList = document.getElementById('batchResultsList');
        const exportBtn = document.getElementById('exportBatchResults');

        if (batchResults.length === 0) return;

        const successCount = batchResults.filter(r => r.success).length;
        const failCount = batchResults.length - successCount;

        let html = `
            <div class="alert alert-info mb-3">
                <strong>å¤„ç†å®Œæˆï¼š</strong>
                æˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ªï¼Œå…± ${batchResults.length} ä¸ªé¢˜ç›®
            </div>
        `;

        batchResults.forEach(result => {
            const statusClass = result.success ? 'success' : 'danger';
            const statusIcon = result.success ? 'check-circle-fill' : 'x-circle-fill';

            html += `
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-${statusIcon} text-${statusClass} me-2"></i>
                            é¢˜ç›® ${result.index}
                        </span>
                        <button class="btn btn-sm btn-outline-primary copy-result-btn"
                                data-answer="${result.answer}" title="å¤åˆ¶ç­”æ¡ˆ">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>é¢˜ç›®ï¼š</strong>${result.cleanedQuestion}</p>
                        <p class="mb-2">
                            <strong>ç­”æ¡ˆï¼š</strong>
                            <span class="text-${statusClass}">${result.answer}</span>
                        </p>
                        ${result.error ? `<p class="text-danger mb-0"><small>é”™è¯¯ï¼š${result.error}</small></p>` : ''}
                    </div>
                </div>
            `;
        });

        resultsList.innerHTML = html;
        resultsDiv.style.display = 'block';
        exportBtn.style.display = 'inline-block';

        // æ·»åŠ å¤åˆ¶æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.copy-result-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const answer = this.getAttribute('data-answer');
                copyToClipboard(answer);
                showToast('ç­”æ¡ˆå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            });
        });
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿å‡½æ•°
    function copyToClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text);
        } else {
            // å…¼å®¹æ—§æµè§ˆå™¨
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }
    }

    // å¯¼å‡ºæ‰¹é‡æœé¢˜ç»“æœ
    document.getElementById('exportBatchResults').addEventListener('click', function () {
        if (batchResults.length === 0) return;

        let content = 'æ‰¹é‡AIæœé¢˜ç»“æœ\n';
        content += 'ç”Ÿæˆæ—¶é—´ï¼š' + new Date().toLocaleString() + '\n';
        content += '='.repeat(50) + '\n\n';

        batchResults.forEach(result => {
            content += `é¢˜ç›® ${result.index}ï¼š\n`;
            content += `é—®é¢˜ï¼š${result.cleanedQuestion}\n`;
            content += `ç­”æ¡ˆï¼š${result.answer}\n`;
            content += `çŠ¶æ€ï¼š${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}\n`;
            if (result.error) {
                content += `é”™è¯¯ï¼š${result.error}\n`;
            }
            content += '-'.repeat(30) + '\n\n';
        });

        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `æ‰¹é‡æœé¢˜ç»“æœ_${new Date().toISOString().slice(0, 10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('ç»“æœå·²å¯¼å‡ºåˆ°æ–‡ä»¶', 'success');
    });
</script>
{% endblock %}