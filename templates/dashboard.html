{% extends 'base.html' %}
{% block title %}EduBrain AI - 智能题库统计面板{% endblock %}
{% block content %}
<!-- 原dashboard主内容区，去除<nav>部分，直接放到content块 -->
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">系统信息</h5>
                </div>
                <div class="card-body">
                    <p><strong>版本：</strong>{{ version }}</p>
                    <p><strong>缓存状态：</strong>{{ "已启用" if cache_enabled else "未启用" }}</p>
                    <p><strong>缓存数量：</strong>{{ cache_size }}条</p>
                    <p><strong>使用模型：</strong>{{ model }}</p>
                    <p><strong>运行时长：</strong>{{ uptime }}</p>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">最近问答记录</h5>
                    <button class="btn btn-light btn-sm" onclick="clearCache()">清除缓存</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="qa-records" class="table table-striped table-hover dt-responsive nowrap" style="width:100%">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>问题类型</th>
                                    <th>问题内容</th>
                                    <th>选项</th>
                                    <th>AI答案</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in records %}
                                <!-- 
                                调试信息:
                                record类型: {{ record.__class__.__name__ }}
                                record数据: {{ record }}
                                -->
                                <tr>
                                    <td data-order="{{ record.timestamp }}">{{ record.time }}</td>
                                    <td>{{ record.type }}</td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 300px;" title="{{ record.question }}">
                                            {{ record.question }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 200px;" title="{{ record.options }}">
                                            {{ record.options }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 200px;" title="{{ record.answer }}">
                                            {{ record.answer }}
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info me-1" data-bs-toggle="modal" data-bs-target="#detailModal{{ loop.index }}">详情</button>
                                        <button class="btn btn-sm btn-warning me-1" data-bs-toggle="modal" data-bs-target="#editModal{{ loop.index }}">编辑</button>
                                        <button class="btn btn-sm btn-danger delete-record" data-record-id="{{ record.id }}">删除</button>
                                    </td>
                                </tr>
                                
                                <!-- 每条记录的模态框 -->
                                <div class="modal fade" id="detailModal{{ loop.index }}" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel{{ loop.index }}" aria-modal="true">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="detailModalLabel{{ loop.index }}">问答详情</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <h6 id="question-label{{ loop.index }}">问题：</h6>
                                                    <pre class="border rounded p-3 bg-light" aria-labelledby="question-label{{ loop.index }}">{{ record.question }}</pre>
                                                </div>
                                                <div class="mb-3">
                                                    <h6 id="type-label{{ loop.index }}">问题类型：</h6>
                                                    <pre class="border rounded p-3 bg-light" aria-labelledby="type-label{{ loop.index }}">{{ record.type or '未指定' }}</pre>
                                                </div>
                                                <div class="mb-3">
                                                    <h6 id="options-label{{ loop.index }}">选项：</h6>
                                                    <pre class="border rounded p-3 bg-light" aria-labelledby="options-label{{ loop.index }}">{{ record.options or '无' }}</pre>
                                                </div>
                                                <div class="mb-3">
                                                    <h6 id="answer-label{{ loop.index }}">答案：</h6>
                                                    <pre class="border rounded p-3 bg-light" aria-labelledby="answer-label{{ loop.index }}">{{ record.answer }}</pre>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 每条记录的编辑模态框 -->
                                <div class="modal fade" id="editModal{{ loop.index }}" tabindex="-1" role="dialog" aria-labelledby="editModalLabel{{ loop.index }}" aria-modal="true">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="editModalLabel{{ loop.index }}">编辑问答</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="editForm{{ loop.index }}" action="/api/record/update" method="POST">
                                                    <input type="hidden" name="record_id" value="{{ record.id }}">
                                                    
                                                    <div class="mb-3">
                                                        <label for="edit-question-{{ loop.index }}" class="form-label">问题内容：</label>
                                                        <textarea class="form-control" id="edit-question-{{ loop.index }}" name="question" rows="3">{{ record.question }}</textarea>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label for="edit-type-{{ loop.index }}" class="form-label">问题类型：</label>
                                                        <select class="form-select" id="edit-type-{{ loop.index }}" name="type">
                                                            <option value="" {% if not record.type %}selected{% endif %}>未指定</option>
                                                            <option value="single" {% if record.type == 'single' %}selected{% endif %}>单选题</option>
                                                            <option value="multiple" {% if record.type == 'multiple' %}selected{% endif %}>多选题</option>
                                                            <option value="judgement" {% if record.type == 'judgement' %}selected{% endif %}>判断题</option>
                                                            <option value="completion" {% if record.type == 'completion' %}selected{% endif %}>填空题</option>
                                                        </select>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label for="edit-options-{{ loop.index }}" class="form-label">选项内容：</label>
                                                        <textarea class="form-control" id="edit-options-{{ loop.index }}" name="options" rows="4">{{ record.options }}</textarea>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label for="edit-answer-{{ loop.index }}" class="form-label">答案：</label>
                                                        <textarea class="form-control" id="edit-answer-{{ loop.index }}" name="answer" rows="2">{{ record.answer }}</textarea>
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                                <button type="button" class="btn btn-primary" onclick="submitEditForm('{{ loop.index }}')">保存</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">确认删除</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <p>您确定要删除这条记录吗？</p>
                <p class="text-danger"><strong>警告：</strong>此操作无法撤销，记录将从数据库中永久删除！</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
