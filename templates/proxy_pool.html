{% extends 'base.html' %}
{% block title %}EduBrain AI - 代理池监控{% endblock %}

{% block styles %}
{{ super() }}
<style>
  /* 代理池监控页面样式优化 */

  /* 顶部按钮区域样式 */
  .card-header .btn {
    border-width: 1px;
    font-weight: 500;
    transition: all 0.2s ease-in-out;
  }

  .card-header .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .card-header .btn-outline-light:hover {
    background-color: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
  }

  /* 操作按钮组样式优化 - 使用更强的选择器 */
  .card-header .btn-group-sm .btn,
  .btn-group-sm .btn {
    padding: 0.375rem 0.5rem !important;
    font-size: 0.875rem !important;
    line-height: 1.2 !important;
    border-radius: 0.25rem !important;
    min-width: 36px !important;
    height: 32px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.15s ease-in-out !important;
    border-width: 1px !important;
  }

  .card-header .btn-group-sm .btn:hover,
  .btn-group-sm .btn:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
    z-index: 2 !important;
  }

  .card-header .btn-group-sm .btn:active,
  .btn-group-sm .btn:active {
    transform: translateY(0) !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
  }

  /* 按钮颜色优化 - 使用更强的选择器 */
  .card-header .btn-group-sm .btn-outline-primary:hover,
  .btn-group-sm .btn-outline-primary:hover,
  .btn-outline-primary:hover {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: #fff !important;
  }

  .card-header .btn-group-sm .btn-outline-warning:hover,
  .btn-group-sm .btn-outline-warning:hover,
  .btn-outline-warning:hover {
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
    color: #000 !important;
  }

  .card-header .btn-group-sm .btn-outline-success:hover,
  .btn-group-sm .btn-outline-success:hover,
  .btn-outline-success:hover {
    background-color: #198754 !important;
    border-color: #198754 !important;
    color: #fff !important;
  }

  .card-header .btn-group-sm .btn-outline-secondary:hover,
  .btn-group-sm .btn-outline-secondary:hover,
  .btn-outline-secondary:hover {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    color: #fff !important;
  }

  .card-header .btn-group-sm .btn-outline-danger:hover,
  .btn-group-sm .btn-outline-danger:hover,
  .btn-outline-danger:hover {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    color: #fff !important;
  }

  /* 按钮组间距优化 - 使用更强的选择器 */
  .card-header .btn-group .btn+.btn,
  .btn-group .btn+.btn {
    margin-left: -1px !important;
  }

  .card-header .btn-group .btn:not(:first-child),
  .btn-group .btn:not(:first-child) {
    border-top-left-radius: 0 !important;
    border-bottom-left-radius: 0 !important;
  }

  .card-header .btn-group .btn:not(:last-child),
  .btn-group .btn:not(:last-child) {
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
  }

  /* 确保按钮组紧密连接 */
  .card-header .btn-group-sm,
  .btn-group-sm {
    display: inline-flex !important;
  }

  .card-header .btn-group-sm .btn,
  .btn-group-sm .btn {
    flex: 0 0 auto !important;
    position: relative !important;
  }

  /* 代理操作按钮组样式优化 */
  .proxy-actions.btn-group-sm .btn {
    padding: 0.375rem 0.75rem !important;
    font-size: 0.875rem !important;
    line-height: 1.2 !important;
    border-radius: 0.25rem !important;
    min-width: auto !important;
    height: auto !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.15s ease-in-out !important;
    border-width: 1px !important;
    margin: 0 !important;
    white-space: nowrap !important;
  }

  /* 按钮文字样式 */
  .proxy-actions .btn-text {
    font-size: 0.8rem !important;
    font-weight: 500 !important;
  }

  /* 响应式按钮文字显示 */
  @media (max-width: 992px) {
    .proxy-actions .btn-text {
      display: none !important;
    }

    .proxy-actions.btn-group-sm .btn {
      padding: 0.375rem 0.5rem !important;
      min-width: 36px !important;
    }

    .proxy-actions .btn i {
      margin-right: 0 !important;
    }
  }

  /* 强制按钮样式 - 最高优先级（保持原有非代理操作按钮的样式） */
  div.card-header div.btn-group.btn-group-sm:not(.proxy-actions) button.btn {
    padding: 0.375rem 0.5rem !important;
    font-size: 0.875rem !important;
    line-height: 1.2 !important;
    border-radius: 0.25rem !important;
    min-width: 36px !important;
    height: 32px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.15s ease-in-out !important;
    border-width: 1px !important;
    margin: 0 !important;
  }

  /* 代理操作按钮悬停效果 */
  .proxy-actions.btn-group-sm .btn:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
    z-index: 2 !important;
  }

  .proxy-actions.btn-group-sm .btn:active {
    transform: translateY(0) !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
  }

  /* 强制按钮悬停效果（保持原有非代理操作按钮的样式） */
  div.card-header div.btn-group.btn-group-sm:not(.proxy-actions) button.btn:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
    z-index: 2 !important;
  }

  /* 强制按钮点击效果（保持原有非代理操作按钮的样式） */
  div.card-header div.btn-group.btn-group-sm:not(.proxy-actions) button.btn:active {
    transform: translateY(0) !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
  }

  /* 代理操作按钮颜色样式 */
  .proxy-actions.btn-group-sm .btn.btn-outline-primary {
    color: #0d6efd !important;
    border-color: #0d6efd !important;
    background-color: transparent !important;
  }

  .proxy-actions.btn-group-sm .btn.btn-outline-primary:hover {
    color: #fff !important;
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
  }

  .proxy-actions.btn-group-sm .btn.btn-outline-warning {
    color: #ffc107 !important;
    border-color: #ffc107 !important;
    background-color: transparent !important;
  }

  .proxy-actions.btn-group-sm .btn.btn-outline-warning:hover {
    color: #000 !important;
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
  }

  .proxy-actions.btn-group-sm .btn.btn-outline-success {
    color: #198754 !important;
    border-color: #198754 !important;
    background-color: transparent !important;
  }

  .proxy-actions.btn-group-sm .btn.btn-outline-success:hover {
    color: #fff !important;
    background-color: #198754 !important;
    border-color: #198754 !important;
  }

  .proxy-actions.btn-group-sm .btn.btn-outline-secondary {
    color: #6c757d !important;
    border-color: #6c757d !important;
    background-color: transparent !important;
  }

  .proxy-actions.btn-group-sm .btn.btn-outline-secondary:hover {
    color: #fff !important;
    background-color: #6c757d !important;
    border-color: #6c757d !important;
  }

  .proxy-actions.btn-group-sm .btn.btn-outline-danger {
    color: #dc3545 !important;
    border-color: #dc3545 !important;
    background-color: transparent !important;
  }

  .proxy-actions.btn-group-sm .btn.btn-outline-danger:hover {
    color: #fff !important;
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
  }

  /* 强制按钮颜色（保持原有非代理操作按钮的样式） */
  div.card-header div.btn-group.btn-group-sm:not(.proxy-actions) button.btn.btn-outline-primary {
    color: #0d6efd !important;
    border-color: #0d6efd !important;
    background-color: transparent !important;
  }

  div.card-header div.btn-group.btn-group-sm:not(.proxy-actions) button.btn.btn-outline-primary:hover {
    color: #fff !important;
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
  }

  div.card-header div.btn-group.btn-group-sm button.btn.btn-outline-warning {
    color: #ffc107 !important;
    border-color: #ffc107 !important;
    background-color: transparent !important;
  }

  div.card-header div.btn-group.btn-group-sm button.btn.btn-outline-warning:hover {
    color: #000 !important;
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
  }

  div.card-header div.btn-group.btn-group-sm button.btn.btn-outline-success {
    color: #198754 !important;
    border-color: #198754 !important;
    background-color: transparent !important;
  }

  div.card-header div.btn-group.btn-group-sm button.btn.btn-outline-success:hover {
    color: #fff !important;
    background-color: #198754 !important;
    border-color: #198754 !important;
  }

  div.card-header div.btn-group.btn-group-sm button.btn.btn-outline-secondary {
    color: #6c757d !important;
    border-color: #6c757d !important;
    background-color: transparent !important;
  }

  div.card-header div.btn-group.btn-group-sm button.btn.btn-outline-secondary:hover {
    color: #fff !important;
    background-color: #6c757d !important;
    border-color: #6c757d !important;
  }

  div.card-header div.btn-group.btn-group-sm button.btn.btn-outline-danger {
    color: #dc3545 !important;
    border-color: #dc3545 !important;
    background-color: transparent !important;
  }

  div.card-header div.btn-group.btn-group-sm button.btn.btn-outline-danger:hover {
    color: #fff !important;
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
  }

  /* 终极按钮修复 - 使用最高优先级选择器 */
  .card .card-header .btn-group.btn-group-sm button[type="button"].btn {
    padding: 0.375rem 0.5rem !important;
    font-size: 0.875rem !important;
    line-height: 1.2 !important;
    border-radius: 0.25rem !important;
    min-width: 36px !important;
    height: 32px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.15s ease-in-out !important;
    border-width: 1px !important;
    margin: 0 !important;
    box-sizing: border-box !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
    z-index: 2 !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn:active {
    transform: translateY(0) !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
  }

  /* 终极按钮颜色修复 */
  .card .card-header .btn-group.btn-group-sm button[type="button"].btn.btn-outline-primary {
    color: #0d6efd !important;
    border-color: #0d6efd !important;
    background-color: transparent !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn.btn-outline-primary:hover {
    color: #fff !important;
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn.btn-outline-warning {
    color: #ffc107 !important;
    border-color: #ffc107 !important;
    background-color: transparent !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn.btn-outline-warning:hover {
    color: #000 !important;
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn.btn-outline-success {
    color: #198754 !important;
    border-color: #198754 !important;
    background-color: transparent !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn.btn-outline-success:hover {
    color: #fff !important;
    background-color: #198754 !important;
    border-color: #198754 !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn.btn-outline-secondary {
    color: #6c757d !important;
    border-color: #6c757d !important;
    background-color: transparent !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn.btn-outline-secondary:hover {
    color: #fff !important;
    background-color: #6c757d !important;
    border-color: #6c757d !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn.btn-outline-danger {
    color: #dc3545 !important;
    border-color: #dc3545 !important;
    background-color: transparent !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn.btn-outline-danger:hover {
    color: #fff !important;
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
  }

  /* 终极按钮组连接修复 */
  .card .card-header .btn-group.btn-group-sm button[type="button"].btn+button[type="button"].btn {
    margin-left: -1px !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn:not(:first-child) {
    border-top-left-radius: 0 !important;
    border-bottom-left-radius: 0 !important;
  }

  .card .card-header .btn-group.btn-group-sm button[type="button"].btn:not(:last-child) {
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
  }

  /* 卡片头部对齐优化 */
  .card-header .d-flex {
    min-height: 40px;
  }

  .form-check-label.small {
    font-size: 0.875rem;
    margin-left: 0.25rem;
  }

  /* 代理操作按钮组连接效果 */
  .proxy-actions.btn-group-sm .btn+.btn {
    margin-left: -1px !important;
  }

  .proxy-actions.btn-group-sm .btn:not(:first-child) {
    border-top-left-radius: 0 !important;
    border-bottom-left-radius: 0 !important;
  }

  .proxy-actions.btn-group-sm .btn:not(:last-child) {
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
  }

  /* 代理操作按钮组整体样式 */
  .proxy-actions.btn-group-sm {
    display: inline-flex !important;
    flex-wrap: nowrap !important;
  }

  /* 性能监控样式 */
  .performance-chart {
    height: 200px;
    margin-top: 1rem;
  }

  .metric-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
  }

  .metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #495057;
  }

  .metric-label {
    font-size: 0.9rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }

  .metric-trend {
    font-size: 0.8rem;
    margin-top: 0.25rem;
  }

  .trend-up {
    color: #28a745;
  }

  .trend-down {
    color: #dc3545;
  }

  .trend-stable {
    color: #6c757d;
  }

  /* 自动故障切换指示器 */
  .failover-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: 5px;
  }

  .failover-active {
    background-color: #28a745;
    animation: pulse 2s infinite;
  }

  .failover-inactive {
    background-color: #6c757d;
  }

  @keyframes pulse {
    0% {
      opacity: 1;
    }

    50% {
      opacity: 0.5;
    }

    100% {
      opacity: 1;
    }
  }

  /* 响应式优化 */
  @media (max-width: 768px) {
    .card-header .d-flex {
      flex-direction: column;
      gap: 0.5rem;
      align-items: stretch;
    }

    .btn-group-sm:not(.proxy-actions) {
      justify-content: center;
    }

    .card-header .btn:not(.proxy-actions .btn) {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
    }

    /* 小屏幕下代理操作按钮的特殊处理 */
    .proxy-actions.btn-group-sm {
      justify-content: center;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .proxy-actions.btn-group-sm .btn {
      flex: 1 1 auto;
      min-width: 60px;
      margin: 0 !important;
      border-radius: 0.25rem !important;
    }
  }

  @media (max-width: 576px) {
    .proxy-actions.btn-group-sm {
      flex-direction: column;
      width: 100%;
    }

    .proxy-actions.btn-group-sm .btn {
      width: 100%;
      margin-bottom: 0.25rem !important;
      border-radius: 0.25rem !important;
    }

    .proxy-actions.btn-group-sm .btn:last-child {
      margin-bottom: 0 !important;
    }
  }

  /* 旋转动画 */
  .rotate-animation {
    animation: rotate 1s linear;
  }

  @keyframes rotate {
    from {
      transform: rotate(0deg);
    }

    to {
      transform: rotate(360deg);
    }
  }

  /* 加载状态样式 */
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn .fa-spinner {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }

    to {
      transform: rotate(360deg);
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- 性能监控面板 -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="metric-card">
        <div class="metric-value" id="totalRequests">0</div>
        <div class="metric-label">总请求数</div>
        <div class="metric-trend">
          <span id="requestsTrend" class="trend-stable">
            <i class="bi bi-dash"></i> 稳定
          </span>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="metric-card">
        <div class="metric-value" id="avgResponseTime">0ms</div>
        <div class="metric-label">平均响应时间</div>
        <div class="metric-trend">
          <span id="responseTrend" class="trend-stable">
            <i class="bi bi-dash"></i> 稳定
          </span>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="metric-card">
        <div class="metric-value" id="successRate">0%</div>
        <div class="metric-label">成功率</div>
        <div class="metric-trend">
          <span id="successTrend" class="trend-stable">
            <i class="bi bi-dash"></i> 稳定
          </span>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="metric-card">
        <div class="metric-value" id="failoverStatus">
          启用
          <span class="failover-indicator failover-active" id="failoverIndicator"></span>
        </div>
        <div class="metric-label">自动故障切换</div>
        <div class="metric-trend">
          <button class="btn btn-sm btn-outline-danger" id="toggleFailover">
            <i class="bi bi-toggle-on"></i> 禁用
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 性能图表 -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h6 class="card-title mb-0">
            <i class="bi bi-graph-up me-2"></i>请求量趋势
          </h6>
        </div>
        <div class="card-body">
          <canvas id="requestChart" class="performance-chart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h6 class="card-title mb-0">
            <i class="bi bi-speedometer2 me-2"></i>响应时间分布
          </h6>
        </div>
        <div class="card-body">
          <canvas id="responseChart" class="performance-chart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- 代理池汇总统计 -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center bg-primary text-white">
        <div class="card-body">
          <h5 class="card-title">总代理数</h5>
          <h2 id="totalProxies">{{ proxy_stats.total_proxies or 0 }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center bg-success text-white">
        <div class="card-body">
          <h5 class="card-title">激活代理</h5>
          <h2 id="activeProxies">{{ proxy_stats.active_proxies or 0 }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center bg-info text-white">
        <div class="card-body">
          <h5 class="card-title">总密钥数</h5>
          <h2 id="totalKeys">{{ proxy_stats.total_api_keys or 0 }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center bg-warning text-white">
        <div class="card-body">
          <h5 class="card-title">支持模型</h5>
          <h2 id="totalModels">{{ proxy_stats.total_models or 0 }}</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- 代理池管理主卡片 -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <span><i class="fas fa-cloud me-2"></i>代理池监控</span>
      <div class="d-flex align-items-center gap-2">
        <button id="addProxyBtn" class="btn btn-sm btn-success" title="添加新代理">
          <i class="fas fa-plus me-1"></i>添加代理
        </button>
        <button id="refreshBtn" class="btn btn-sm btn-outline-light" title="刷新代理池数据">
          <i class="fas fa-sync-alt me-1"></i>刷新
        </button>
        <div class="form-check form-switch mb-0">
          <input class="form-check-input" type="checkbox" id="autoRefreshSwitch" checked>
          <label class="form-check-label text-white small" for="autoRefreshSwitch">自动刷新</label>
        </div>
      </div>
    </div>
    <div class="card-body">
      <!-- 代理池状态区域 -->
      <div class="mb-3 p-3 border rounded bg-light">
        <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>代理池状态</h5>
        <div class="row">
          <div class="col-md-3">
            <div class="d-flex align-items-center mb-2">
              <span class="badge bg-primary me-2">总代理数</span>
              <span id="statusTotalProxies" class="fw-bold">-</span>
            </div>
          </div>
          <div class="col-md-3">
            <div class="d-flex align-items-center mb-2">
              <span class="badge bg-success me-2">激活代理</span>
              <span id="statusActiveProxies" class="fw-bold">-</span>
            </div>
          </div>
          <div class="col-md-3">
            <div class="d-flex align-items-center mb-2">
              <span class="badge bg-info me-2">总密钥数</span>
              <span id="statusTotalKeys" class="fw-bold">-</span>
            </div>
          </div>
          <div class="col-md-3">
            <div class="d-flex align-items-center mb-2">
              <span class="badge bg-warning me-2">支持模型</span>
              <span id="statusTotalModels" class="fw-bold">-</span>
            </div>
          </div>
        </div>
        <div id="lastUpdated" class="text-muted small">最后更新时间：-</div>
      </div>

      <!-- 代理列表区域 -->
      <div class="p-3 border rounded bg-light">
        <h5 class="card-title"><i class="fas fa-list me-2"></i>代理服务列表</h5>
        <div id="tableLoading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
          </div>
          <p class="mt-2">正在加载代理池数据...</p>
        </div>
        <div id="tableContent" style="display:none;">
          <div id="proxiesContainer"></div>
        </div>
        <div id="tableEmpty" class="alert alert-warning" style="display:none;">
          <i class="fas fa-exclamation-triangle me-2"></i>暂无代理数据
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 添加/编辑代理模态框 -->
<div class="modal fade" id="proxyModal" tabindex="-1" aria-labelledby="proxyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="proxyModalLabel">添加代理</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="proxyForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="proxyName" class="form-label">代理名称 *</label>
                <input type="text" class="form-control" id="proxyName" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="proxyPriority" class="form-label">优先级</label>
                <input type="number" class="form-control" id="proxyPriority" value="1" min="1">
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="proxyApiBase" class="form-label">API基础URL *</label>
            <input type="url" class="form-control" id="proxyApiBase" placeholder="https://api.example.com" required>
          </div>

          <div class="mb-3">
            <label for="proxyApiKeys" class="form-label">API密钥 * (每行一个)</label>
            <textarea class="form-control" id="proxyApiKeys" rows="3" placeholder="sk-xxx&#10;sk-yyy"
              required></textarea>
            <div class="form-text">每行输入一个API密钥</div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="proxyDefaultModel" class="form-label">默认模型 *</label>
                <input type="text" class="form-control" id="proxyDefaultModel" placeholder="gpt-3.5-turbo" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="proxyModels" class="form-label">支持的模型列表</label>
                <div class="input-group">
                  <textarea class="form-control" id="proxyModels" rows="3"
                    placeholder="gpt-3.5-turbo&#10;gpt-4"></textarea>
                  <button type="button" class="btn btn-outline-secondary" id="discoverModelsBtn" title="自动发现模型并设置默认值">
                    <i class="fas fa-magic"></i> 智能发现
                  </button>
                </div>
                <div class="form-text">每行一个模型名称，或点击"自动发现"</div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="proxyIsActive" checked>
              <label class="form-check-label" for="proxyIsActive">
                启用此代理
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-outline-info" id="testConnectionBtn" title="测试连接并自动填充模型信息">
          <i class="fas fa-heartbeat"></i> 测试并自动填充
        </button>
        <button type="button" class="btn btn-primary" id="saveProxyBtn">保存</button>
      </div>
    </div>
  </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmModalLabel">确认删除</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>您确定要删除代理 "<span id="deleteProxyName"></span>" 吗？</p>
        <p class="text-danger"><strong>警告：</strong>此操作无法撤销！</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block scripts %}
{{ super() }}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // 第三方API代理池监控 - v2.0.0
  // 全局变量
  let autoRefreshInterval = null;
  let healthCheckInterval = null;
  let performanceInterval = null;
  const refreshInterval = 30000; // 30秒
  const healthCheckRefreshInterval = 60000; // 60秒
  const performanceRefreshInterval = 10000; // 10秒

  // 全局健康状态
  window.healthStatus = {};

  // 性能监控数据
  let performanceData = {
    requests: [],
    responseTimes: [],
    timestamps: []
  };

  // 图表实例
  let requestChart = null;
  let responseChart = null;

  // 自动故障切换状态
  let failoverEnabled = true;

  // 加载故障转移状态
  function loadFailoverStatus() {
    fetch('/api/proxy/failover-status')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const status = data.failover_status;
          failoverEnabled = status.enabled;

          // 更新UI
          updateFailoverUI();

          // 更新代理健康状态显示
          updateProxyHealthDisplay(status.proxies);
        }
      })
      .catch(error => {
        console.error('获取故障转移状态失败:', error);
      });
  }

  // 更新故障转移UI
  function updateFailoverUI() {
    const button = document.getElementById('toggleFailover');
    const indicator = document.getElementById('failoverIndicator');
    const status = document.getElementById('failoverStatus');

    if (failoverEnabled) {
      button.innerHTML = '<i class="bi bi-toggle-on"></i> 禁用';
      button.className = 'btn btn-sm btn-outline-danger';
      indicator.className = 'failover-indicator failover-active';
      status.innerHTML = '启用 <span class="failover-indicator failover-active"></span>';
    } else {
      button.innerHTML = '<i class="bi bi-toggle-off"></i> 启用';
      button.className = 'btn btn-sm btn-outline-primary';
      indicator.className = 'failover-indicator failover-inactive';
      status.innerHTML = '关闭 <span class="failover-indicator failover-inactive"></span>';
    }
  }

  // 更新代理健康状态显示
  function updateProxyHealthDisplay(proxies) {
    // 在代理列表中显示健康状态
    Object.keys(proxies).forEach(proxyName => {
      const health = proxies[proxyName];
      const proxyRow = document.querySelector(`[data-proxy-name="${proxyName}"]`);
      if (proxyRow) {
        const healthBadge = proxyRow.querySelector('.health-badge');
        if (healthBadge) {
          let badgeClass = 'badge-success';
          let badgeText = '健康';

          switch (health.status) {
            case 'unhealthy':
              badgeClass = 'badge-danger';
              badgeText = '不健康';
              break;
            case 'degraded':
              badgeClass = 'badge-warning';
              badgeText = '降级';
              break;
            case 'recovering':
              badgeClass = 'badge-info';
              badgeText = '恢复中';
              break;
          }

          healthBadge.className = `badge ${badgeClass} health-badge`;
          healthBadge.textContent = badgeText;
          healthBadge.title = `连续失败: ${health.consecutive_failures}, 最近失败: ${health.recent_failures}`;
        }
      }
    });
  }

  // 加载代理池数据
  function loadProxyPool() {
    // 显示加载状态
    document.getElementById('tableLoading').style.display = 'block';
    document.getElementById('tableContent').style.display = 'none';
    document.getElementById('tableEmpty').style.display = 'none';

    fetch('/api/key_pool')
      .then(res => res.json())
      .then(data => {
        // 更新汇总统计卡片
        document.getElementById('totalProxies').textContent = data.total_proxies || 0;
        document.getElementById('activeProxies').textContent = data.active_proxies || 0;
        document.getElementById('totalKeys').textContent = data.total_keys || 0;
        document.getElementById('totalModels').textContent = data.total_models || 0;

        // 更新状态区域
        document.getElementById('statusTotalProxies').textContent = data.total_proxies || 0;
        document.getElementById('statusActiveProxies').textContent = data.active_proxies || 0;
        document.getElementById('statusTotalKeys').textContent = data.total_keys || 0;
        document.getElementById('statusTotalModels').textContent = data.total_models || 0;

        // 更新最后更新时间
        const now = new Date();
        document.getElementById('lastUpdated').textContent = `最后更新时间：${now.toLocaleString()}`;

        // 更新代理列表
        const container = document.getElementById('proxiesContainer');

        if (data.proxies && data.proxies.length > 0) {
          container.innerHTML = data.proxies.map((proxy, index) => {
            const statusBadge = proxy.is_active
              ? '<span class="badge bg-success">激活</span>'
              : '<span class="badge bg-secondary">禁用</span>';

            const priorityBadge = `<span class="badge bg-primary">优先级: ${proxy.priority}</span>`;

            // 健康状态徽章
            const healthStatus = window.healthStatus && window.healthStatus[proxy.name];
            let healthBadge = '<span class="badge bg-secondary">未知</span>';
            if (healthStatus) {
              switch (healthStatus.status) {
                case 'online':
                  healthBadge = `<span class="badge bg-success" title="响应时间: ${healthStatus.response_time}ms">在线</span>`;
                  break;
                case 'offline':
                  healthBadge = `<span class="badge bg-danger" title="${healthStatus.error_message}">离线</span>`;
                  break;
                case 'timeout':
                  healthBadge = '<span class="badge bg-warning" title="连接超时">超时</span>';
                  break;
                case 'error':
                  healthBadge = `<span class="badge bg-danger" title="${healthStatus.error_message}">异常</span>`;
                  break;
              }
            }

            return `
              <div class="card mb-3 ${proxy.is_active ? 'border-success' : 'border-secondary'}">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-0">
                      <i class="fas fa-cloud me-2"></i>${proxy.name}
                      ${statusBadge}
                      ${priorityBadge}
                      ${healthBadge}
                    </h6>
                    <small class="text-muted">${proxy.api_base}</small>
                  </div>
                  <div class="btn-group btn-group-sm proxy-actions" role="group" aria-label="代理操作">
                    <button type="button" class="btn btn-outline-primary" onclick="testProxy('${proxy.name}')" title="测试连接" data-bs-toggle="tooltip">
                      <i class="fas fa-heartbeat me-1"></i>
                      <span class="btn-text">测试</span>
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="editProxy('${proxy.name}')" title="编辑代理" data-bs-toggle="tooltip">
                      <i class="fas fa-edit me-1"></i>
                      <span class="btn-text">编辑</span>
                    </button>
                    <button type="button" class="btn ${proxy.is_active ? 'btn-outline-secondary' : 'btn-outline-success'}"
                            onclick="toggleProxyStatus('${proxy.name}')"
                            title="${proxy.is_active ? '禁用代理' : '启用代理'}" data-bs-toggle="tooltip">
                      <i class="fas ${proxy.is_active ? 'fa-pause' : 'fa-play'} me-1"></i>
                      <span class="btn-text">${proxy.is_active ? '禁用' : '启用'}</span>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteProxy('${proxy.name}')" title="删除代理" data-bs-toggle="tooltip">
                      <i class="fas fa-trash me-1"></i>
                      <span class="btn-text">删除</span>
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-2">
                        <strong>API密钥数量：</strong>
                        <span class="badge bg-info">${proxy.keys_count} 个</span>
                      </div>
                      <div class="mb-2">
                        <strong>支持模型数量：</strong>
                        <span class="badge bg-warning">${proxy.models_count} 个</span>
                      </div>
                      <div class="mb-2">
                        <strong>默认模型：</strong>
                        <code>${proxy.default_model}</code>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-2">
                        <strong>当前密钥：</strong>
                        <code>${proxy.current_key || '未设置'}</code>
                      </div>
                      <div class="mb-2">
                        <strong>密钥列表：</strong>
                        <button class="btn btn-sm btn-outline-primary"
                                onclick="toggleKeys('proxy-${index}')"
                                id="toggleBtn-${index}">
                          <i class="fas fa-eye"></i> 显示密钥
                        </button>
                      </div>
                    </div>
                  </div>
                  <div id="proxy-${index}" class="mt-3" style="display:none;">
                    <h6>密钥列表：</h6>
                    <div class="table-responsive">
                      <table class="table table-sm table-striped">
                        <thead>
                          <tr>
                            <th>序号</th>
                            <th>密钥（部分明文）</th>
                            <th>状态</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${(proxy.keys || []).map((key, keyIndex) => {
              const isCurrent = key === proxy.current_key;
              return `
                              <tr class="${isCurrent ? 'table-success' : ''}">
                                <td>${keyIndex + 1}</td>
                                <td><code>${key}</code></td>
                                <td>${isCurrent ? '<span class="badge bg-success"><i class="fas fa-check"></i> 当前</span>' : ''}</td>
                              </tr>
                            `;
            }).join('')}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          // 显示内容
          document.getElementById('tableLoading').style.display = 'none';
          document.getElementById('tableContent').style.display = 'block';

          // 初始化工具提示
          initializeTooltips();
        } else {
          // 显示空提示
          document.getElementById('tableLoading').style.display = 'none';
          document.getElementById('tableEmpty').style.display = 'block';
        }
      })
      .catch(error => {
        console.error('Error loading proxy pool:', error);
        document.getElementById('tableLoading').style.display = 'none';
        document.getElementById('tableEmpty').style.display = 'block';
        document.getElementById('tableEmpty').innerHTML = `
          <i class="fas fa-exclamation-circle me-2"></i>加载代理池数据失败，请检查网络连接或刷新页面
        `;
      });
  }

  // 切换密钥显示
  function toggleKeys(proxyId) {
    const element = document.getElementById(proxyId);
    const btn = document.getElementById('toggleBtn-' + proxyId.split('-')[1]);

    if (element.style.display === 'none') {
      element.style.display = 'block';
      btn.innerHTML = '<i class="fas fa-eye-slash"></i> 隐藏密钥';
    } else {
      element.style.display = 'none';
      btn.innerHTML = '<i class="fas fa-eye"></i> 显示密钥';
    }
  }

  // 加载健康检查状态
  function loadHealthStatus() {
    fetch('/api/proxy/health-check')
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          window.healthStatus = data.health_status;
        }
      })
      .catch(error => {
        console.error('Error loading health status:', error);
      });
  }

  // 代理管理函数
  function addProxy() {
    document.getElementById('proxyModalLabel').textContent = '添加代理';
    document.getElementById('proxyForm').reset();
    document.getElementById('proxyName').readOnly = false;
    document.getElementById('saveProxyBtn').onclick = saveProxy;
    new bootstrap.Modal(document.getElementById('proxyModal')).show();
  }

  function editProxy(proxyName) {
    // 获取代理的完整信息（包含未掩码的API密钥）
    fetch('/api/proxy/get-full-info', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: proxyName })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success && data.proxy) {
          const proxy = data.proxy;
          document.getElementById('proxyModalLabel').textContent = '编辑代理';
          document.getElementById('proxyName').value = proxy.name || '';
          document.getElementById('proxyName').readOnly = true;
          document.getElementById('proxyApiBase').value = proxy.api_base || '';
          document.getElementById('proxyApiKeys').value = (proxy.keys || []).join('\n');
          document.getElementById('proxyDefaultModel').value = proxy.default_model || '';
          document.getElementById('proxyModels').value = (proxy.models || []).join('\n');
          document.getElementById('proxyIsActive').checked = proxy.is_active !== false;
          document.getElementById('proxyPriority').value = proxy.priority || 1;
          document.getElementById('saveProxyBtn').onclick = () => updateProxy(proxyName);
          new bootstrap.Modal(document.getElementById('proxyModal')).show();
        } else {
          showAlert(data.message || `未找到代理: ${proxyName}`, 'warning');
        }
      })
      .catch(error => {
        console.error('Error loading proxy data:', error);
        showAlert('加载代理数据失败', 'danger');
      });
  }

  function saveProxy() {
    const formData = getProxyFormData();
    if (!validateProxyForm(formData)) return;

    fetch('/api/proxy/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showAlert(data.message, 'success');
          bootstrap.Modal.getInstance(document.getElementById('proxyModal')).hide();
          loadProxyPool();
        } else {
          showAlert(data.message, 'danger');
        }
      })
      .catch(error => {
        console.error('Error saving proxy:', error);
        showAlert('保存代理失败', 'danger');
      });
  }

  function updateProxy(proxyName) {
    const formData = getProxyFormData();
    formData.name = proxyName; // 确保使用原始名称
    if (!validateProxyForm(formData)) return;

    fetch('/api/proxy/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showAlert(data.message, 'success');
          bootstrap.Modal.getInstance(document.getElementById('proxyModal')).hide();
          loadProxyPool();
        } else {
          showAlert(data.message, 'danger');
        }
      })
      .catch(error => {
        console.error('Error updating proxy:', error);
        showAlert('更新代理失败', 'danger');
      });
  }

  function deleteProxy(proxyName) {
    document.getElementById('deleteProxyName').textContent = proxyName;
    document.getElementById('confirmDeleteBtn').onclick = () => confirmDeleteProxy(proxyName);
    new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
  }

  function confirmDeleteProxy(proxyName) {
    fetch('/api/proxy/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: proxyName })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showAlert(data.message, 'success');
          bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
          loadProxyPool();
        } else {
          showAlert(data.message, 'danger');
        }
      })
      .catch(error => {
        console.error('Error deleting proxy:', error);
        showAlert('删除代理失败', 'danger');
      });
  }

  function toggleProxyStatus(proxyName) {
    fetch('/api/proxy/toggle-status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: proxyName })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showAlert(data.message, 'success');
          loadProxyPool();
        } else {
          showAlert(data.message, 'danger');
        }
      })
      .catch(error => {
        console.error('Error toggling proxy status:', error);
        showAlert('切换代理状态失败', 'danger');
      });
  }

  function testProxy(proxyName) {
    // 创建一个简单的测试函数，不依赖模态框
    showAlert('正在测试代理连接...', 'info');

    // 获取代理的完整信息进行测试
    fetch('/api/proxy/get-full-info', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: proxyName })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success && data.proxy && data.proxy.keys && data.proxy.keys.length > 0) {
          const proxy = data.proxy;
          // 直接调用测试API
          fetch('/api/proxy/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              api_base: proxy.api_base,
              api_key: proxy.keys[0],
              auto_fill: false
            })
          })
            .then(res => res.json())
            .then(testData => {
              if (testData.success) {
                showAlert(`代理 "${proxyName}" 测试成功！响应时间: ${testData.response_time}ms`, 'success');
              } else {
                showAlert(`代理 "${proxyName}" 测试失败: ${testData.message}`, 'danger');
              }
            })
            .catch(error => {
              console.error('Error testing proxy:', error);
              showAlert(`代理 "${proxyName}" 测试失败: 网络错误`, 'danger');
            });
        } else {
          showAlert(data.message || '代理信息不完整或无可用密钥', 'warning');
        }
      })
      .catch(error => {
        console.error('Error loading proxy for test:', error);
        showAlert('获取代理信息失败', 'danger');
      });
  }

  // 切换自动刷新
  function toggleAutoRefresh(enabled) {
    if (enabled) {
      // 启动自动刷新
      if (!autoRefreshInterval) {
        autoRefreshInterval = setInterval(loadProxyPool, refreshInterval);
        console.log('Auto refresh enabled, interval:', refreshInterval);
      }
    } else {
      // 停止自动刷新
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('Auto refresh disabled');
      }
    }
  }

  // 辅助函数
  function getProxyFormData() {
    return {
      name: document.getElementById('proxyName').value.trim(),
      api_base: document.getElementById('proxyApiBase').value.trim(),
      api_keys: document.getElementById('proxyApiKeys').value.split('\n').map(k => k.trim()).filter(k => k),
      model: document.getElementById('proxyDefaultModel').value.trim(),
      models: document.getElementById('proxyModels').value.split('\n').map(m => m.trim()).filter(m => m),
      is_active: document.getElementById('proxyIsActive').checked,
      priority: parseInt(document.getElementById('proxyPriority').value) || 1
    };
  }

  function validateProxyForm(data) {
    if (!data.name) {
      showAlert('请输入代理名称', 'warning');
      return false;
    }
    if (!data.api_base) {
      showAlert('请输入API基础URL', 'warning');
      return false;
    }
    if (!data.api_keys.length) {
      showAlert('请输入至少一个API密钥', 'warning');
      return false;
    }
    if (!data.model) {
      showAlert('请输入默认模型', 'warning');
      return false;
    }
    if (!data.models.length) {
      showAlert('请输入支持的模型列表', 'warning');
      return false;
    }
    return true;
  }

  function testConnection(apiBase, apiKey, autoFill = false) {
    const btn = document.getElementById('testConnectionBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
    btn.disabled = true;

    fetch('/api/proxy/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        api_base: apiBase,
        api_key: apiKey,
        auto_fill: autoFill
      })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          let message = `连接测试成功！响应时间: ${data.response_time}ms`;

          // 如果启用自动填充
          if (autoFill) {
            // 自动设置代理名称（仅在添加新代理时）
            const nameField = document.getElementById('proxyName');
            if (data.suggested_name && !nameField.readOnly && !nameField.value.trim()) {
              nameField.value = data.suggested_name;
              message += `\n已自动设置代理名称: ${data.suggested_name}`;
            }

            // 如果有模型数据，自动填充模型信息
            if (data.models && data.models.length > 0) {
              // 自动填充模型列表
              document.getElementById('proxyModels').value = data.models.join('\n');

              // 自动设置默认模型
              if (data.default_model) {
                document.getElementById('proxyDefaultModel').value = data.default_model;
              }

              message += `\n已自动填充 ${data.models.length} 个模型`;
              if (data.default_model) {
                message += `\n默认模型: ${data.default_model}`;
              }
            }
          }

          showAlert(message, 'success');
        } else {
          let message = `连接测试失败: ${data.message}`;

          // 即使测试失败，如果启用自动填充且有建议名称，也尝试设置
          if (autoFill && data.suggested_name) {
            const nameField = document.getElementById('proxyName');
            if (!nameField.readOnly && !nameField.value.trim()) {
              nameField.value = data.suggested_name;
              message += `\n已自动设置代理名称: ${data.suggested_name}`;
            }
          }

          showAlert(message, 'danger');
        }
      })
      .catch(error => {
        console.error('Error testing connection:', error);
        showAlert('连接测试失败', 'danger');
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
  }

  function discoverModels() {
    const apiBase = document.getElementById('proxyApiBase').value.trim();
    const apiKeys = document.getElementById('proxyApiKeys').value.split('\n').map(k => k.trim()).filter(k => k);

    if (!apiBase || !apiKeys.length) {
      showAlert('请先填写API基础URL和API密钥', 'warning');
      return;
    }

    const btn = document.getElementById('discoverModelsBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 发现中...';
    btn.disabled = true;

    fetch('/api/proxy/discover-models', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ api_base: apiBase, api_key: apiKeys[0] })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // 填充模型列表
          document.getElementById('proxyModels').value = data.models.join('\n');

          // 自动设置默认模型
          if (data.default_model) {
            document.getElementById('proxyDefaultModel').value = data.default_model;
          }

          // 自动设置代理名称（仅在添加新代理时）
          const nameField = document.getElementById('proxyName');
          if (data.suggested_name && !nameField.readOnly && !nameField.value.trim()) {
            nameField.value = data.suggested_name;
          }

          let message = data.message;
          if (data.default_model) {
            message += `\n已自动设置默认模型: ${data.default_model}`;
          }
          if (data.suggested_name && !nameField.readOnly && !nameField.value.trim()) {
            message += `\n已自动设置代理名称: ${data.suggested_name}`;
          }

          showAlert(message, 'success');
        } else {
          let message = `模型发现失败: ${data.message}`;

          // 即使发现失败，如果有建议名称，也尝试设置
          if (data.suggested_name) {
            const nameField = document.getElementById('proxyName');
            if (!nameField.readOnly && !nameField.value.trim()) {
              nameField.value = data.suggested_name;
              message += `\n已自动设置代理名称: ${data.suggested_name}`;
            }
          }

          showAlert(message, 'warning');
        }
      })
      .catch(error => {
        console.error('Error discovering models:', error);
        showAlert('模型发现失败', 'danger');
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
  }

  function showAlert(message, type) {
    // 创建临时提示框
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    alertDiv.innerHTML = `
      <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'danger' ? 'fa-exclamation-circle' : 'fa-info-circle'} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    // 3秒后自动移除
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.parentNode.removeChild(alertDiv);
      }
    }, 3000);
  }

  function initializeTooltips() {
    // 初始化Bootstrap工具提示
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  }

  // 初始化性能监控图表
  function initializePerformanceCharts() {
    // 请求量趋势图
    const requestCtx = document.getElementById('requestChart').getContext('2d');
    requestChart = new Chart(requestCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: '请求数/分钟',
          data: [],
          borderColor: '#007bff',
          backgroundColor: 'rgba(0, 123, 255, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });

    // 响应时间分布图
    const responseCtx = document.getElementById('responseChart').getContext('2d');
    responseChart = new Chart(responseCtx, {
      type: 'bar',
      data: {
        labels: ['<100ms', '100-500ms', '500ms-1s', '1s-3s', '>3s'],
        datasets: [{
          label: '请求数',
          data: [0, 0, 0, 0, 0],
          backgroundColor: [
            '#28a745',
            '#ffc107',
            '#fd7e14',
            '#dc3545',
            '#6f42c1'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
  }

  // 更新性能指标
  function updatePerformanceMetrics() {
    fetch('/api/proxy/performance-metrics')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 更新基础指标
          document.getElementById('totalRequests').textContent = data.total_requests || 0;
          document.getElementById('avgResponseTime').textContent = (data.avg_response_time || 0) + 'ms';
          document.getElementById('successRate').textContent = (data.success_rate || 0) + '%';

          // 更新图表数据
          if (data.request_timeline && requestChart) {
            const timeline = data.request_timeline;
            requestChart.data.labels = timeline.timestamps || [];
            requestChart.data.datasets[0].data = timeline.requests || [];
            requestChart.update('none');
          }

          if (data.response_distribution && responseChart) {
            const distribution = data.response_distribution;
            responseChart.data.datasets[0].data = [
              distribution.under_100ms || 0,
              distribution.ms_100_500 || 0,
              distribution.ms_500_1000 || 0,
              distribution.s_1_3 || 0,
              distribution.over_3s || 0
            ];
            responseChart.update('none');
          }
        }
      })
      .catch(error => {
        console.error('获取性能指标失败:', error);
      });
  }

  // 事件监听器
  document.addEventListener('DOMContentLoaded', function () {
    // 初始化性能监控图表
    initializePerformanceCharts();

    // 开始性能监控
    updatePerformanceMetrics();
    performanceInterval = setInterval(updatePerformanceMetrics, performanceRefreshInterval);

    // 初始加载代理池数据和健康状态
    loadProxyPool();
    loadHealthStatus();
    loadFailoverStatus();

    // 刷新按钮点击事件
    document.getElementById('refreshBtn').addEventListener('click', function () {
      const btn = this;
      const icon = btn.querySelector('i');
      const originalText = btn.innerHTML;

      // 添加加载状态
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>刷新中...';

      // 执行刷新
      Promise.all([
        fetch('/api/key_pool').then(res => res.json()),
        fetch('/api/proxy/health-check').then(res => res.json()).catch(() => ({}))
      ]).then(([poolData, healthData]) => {
        // 更新健康状态
        if (healthData.success) {
          window.healthStatus = healthData.health_status;
        }
        // 重新加载代理池数据
        loadProxyPool();
      }).catch(error => {
        console.error('Error refreshing data:', error);
        showAlert('刷新数据失败', 'danger');
      }).finally(() => {
        // 恢复按钮状态
        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }, 500);
      });
    });

    // 添加代理按钮
    document.getElementById('addProxyBtn').addEventListener('click', addProxy);

    // 模态框内的按钮事件
    document.getElementById('testConnectionBtn').addEventListener('click', function () {
      const apiBase = document.getElementById('proxyApiBase').value.trim();
      const apiKeys = document.getElementById('proxyApiKeys').value.split('\n').map(k => k.trim()).filter(k => k);
      if (apiBase && apiKeys.length > 0) {
        // 启用自动填充功能
        testConnection(apiBase, apiKeys[0], true);
      } else {
        showAlert('请先填写API基础URL和API密钥', 'warning');
      }
    });

    document.getElementById('discoverModelsBtn').addEventListener('click', discoverModels);

    // 自动刷新开关
    document.getElementById('autoRefreshSwitch').addEventListener('change', function () {
      toggleAutoRefresh(this.checked);
    });

    // 故障切换按钮
    document.getElementById('toggleFailover').addEventListener('click', function () {
      const button = this;
      const indicator = document.getElementById('failoverIndicator');
      const status = document.getElementById('failoverStatus');

      fetch('/api/proxy/toggle-failover', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          enabled: !failoverEnabled
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            failoverEnabled = data.enabled;

            if (failoverEnabled) {
              button.innerHTML = '<i class="bi bi-toggle-on"></i> 禁用';
              button.className = 'btn btn-sm btn-outline-danger';
              indicator.className = 'failover-indicator failover-active';
              status.innerHTML = '启用 <span class="failover-indicator failover-active"></span>';
            } else {
              button.innerHTML = '<i class="bi bi-toggle-off"></i> 启用';
              button.className = 'btn btn-sm btn-outline-primary';
              indicator.className = 'failover-indicator failover-inactive';
              status.innerHTML = '关闭 <span class="failover-indicator failover-inactive"></span>';
            }

            showAlert(data.message, 'success');
          } else {
            showAlert(data.message || '操作失败', 'danger');
          }
        })
        .catch(error => {
          console.error('切换故障切换失败:', error);
          showAlert('操作失败，请重试', 'danger');
        });
    });

    // 启动健康检查定时器
    healthCheckInterval = setInterval(() => {
      loadHealthStatus();
    }, healthCheckRefreshInterval);

    // 默认启动自动刷新
    toggleAutoRefresh(true);
  });

  // 切换自动刷新
  function toggleAutoRefresh(enabled) {
    if (enabled) {
      if (!autoRefreshInterval) {
        autoRefreshInterval = setInterval(() => {
          loadProxyPool();
          loadHealthStatus();
        }, refreshInterval);
        console.log('自动刷新已启用');
      }
    } else {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('自动刷新已禁用');
      }
    }
  }

  // 页面卸载时清理定时器
  window.addEventListener('beforeunload', function () {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }
    if (healthCheckInterval) {
      clearInterval(healthCheckInterval);
    }
    if (performanceInterval) {
      clearInterval(performanceInterval);
    }
  });
</script>

<style>
  /* 旋转动画 */
  @keyframes rotate {
    from {
      transform: rotate(0deg);
    }

    to {
      transform: rotate(360deg);
    }
  }

  .rotate-animation {
    animation: rotate 1s linear;
  }

  /* 表格样式 */
  #keyPoolTable code {
    font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.9em;
    background-color: #f8f9fa;
    padding: 0.2em 0.4em;
    border-radius: 3px;
  }

  /* 响应式调整 */
  @media (max-width: 768px) {
    .card-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .card-header>div {
      margin-top: 0.5rem;
    }
  }
</style>
{% endblock %}