{% extends 'base.html' %}
{% block title %}EduBrain AI - 密钥池管理{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <span><i class="fas fa-key me-2"></i>密钥池管理</span>
      <div>
        <button id="refreshBtn" class="btn btn-sm btn-light" title="刷新密钥池数据">
          <i class="fas fa-sync-alt"></i>
        </button>
        <div class="form-check form-switch d-inline-block ms-2">
          <input class="form-check-input" type="checkbox" id="autoRefreshSwitch">
          <label class="form-check-label text-white" for="autoRefreshSwitch">自动刷新</label>
        </div>
      </div>
    </div>
    <div class="card-body">
      <!-- Session设置区域 -->
      <div class="mb-4 p-3 border rounded bg-light">
        <h5 class="card-title"><i class="fas fa-cog me-2"></i>Session 配置</h5>
        <div class="mb-3">
          <label for="sessionInput" class="form-label fw-bold">Veloera Session：</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-lock"></i></span>
            <input type="text" class="form-control" id="sessionInput" 
                   placeholder="请输入 Veloera 后台 session" 
                   autocomplete="off"
                   aria-describedby="sessionHelp">
            <button class="btn btn-primary" id="saveSessionBtn" type="button">
              <span id="saveBtnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              <span id="saveBtnText">保存</span>
            </button>
          </div>
          <div id="sessionHelp" class="form-text">请从 Veloera 后台复制 session 值粘贴到此处，保存后将自动同步密钥</div>
          <div id="sessionSaveMsg" class="alert mt-2" style="display:none;"></div>
        </div>
      </div>
      
      <!-- 密钥池状态区域 -->
      <div class="mb-3 p-3 border rounded bg-light">
        <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>密钥池状态</h5>
        <div class="row">
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-2">
              <span class="badge bg-primary me-2">密钥数量</span>
              <span id="keyPoolCount" class="fw-bold">-</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-2">
              <span class="badge bg-success me-2">当前主密钥</span>
              <span id="currentKey" class="fw-bold">-</span>
            </div>
          </div>
        </div>
        <div id="lastUpdated" class="text-muted small">最后更新时间：-</div>
      </div>
      
      <!-- 密钥列表区域 -->
      <div class="p-3 border rounded bg-light">
        <h5 class="card-title"><i class="fas fa-list me-2"></i>密钥列表</h5>
        <div id="tableLoading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
          </div>
          <p class="mt-2">正在加载密钥数据...</p>
        </div>
        <div id="tableContent" style="display:none;">
          <div class="table-responsive mt-3">
            <table class="table table-striped table-hover" id="keyPoolTable">
              <thead class="table-dark">
                <tr>
                  <th style="width:60px;">序号</th>
                  <th>密钥（部分明文）</th>
                  <th style="width:80px;">状态</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div id="tableEmpty" class="alert alert-warning" style="display:none;">
          <i class="fas fa-exclamation-triangle me-2"></i>暂无密钥数据，请先配置并保存 Session
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
// 全局变量
 let autoRefreshInterval = null;
 const refreshInterval = 30000; // 30秒

// 加载密钥池数据
 function loadKeyPool() {
    // 显示加载状态
    document.getElementById('tableLoading').style.display = 'block';
    document.getElementById('tableContent').style.display = 'none';
    document.getElementById('tableEmpty').style.display = 'none';
    
    fetch('/api/key_pool')
        .then(res => res.json())
        .then(data => {
            // 更新密钥池状态
            document.getElementById('keyPoolCount').textContent = data.count || 0;
            document.getElementById('currentKey').textContent = data.current || '-';
            
            // 更新最后更新时间
            const now = new Date();
            document.getElementById('lastUpdated').textContent = `最后更新时间：${now.toLocaleString()}`;
            
            // 更新密钥表格
            const tbody = document.querySelector('#keyPoolTable tbody');
            
            if (data.keys && data.keys.length > 0) {
                tbody.innerHTML = data.keys.map((k, i) => {
                    const isCurrent = k === data.current;
                    return `
                        <tr class="${isCurrent ? 'table-success' : ''}">
                            <td class="text-center">${i+1}</td>
                            <td><code>${k}</code></td>
                            <td class="text-center">${isCurrent ? '<span class="badge bg-success"><i class="fas fa-check"></i> 主密钥</span>' : ''}</td>
                        </tr>
                    `;
                }).join('');
                
                // 显示表格内容
                document.getElementById('tableLoading').style.display = 'none';
                document.getElementById('tableContent').style.display = 'block';
            } else {
                // 显示空提示
                document.getElementById('tableLoading').style.display = 'none';
                document.getElementById('tableEmpty').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading key pool:', error);
            document.getElementById('tableLoading').style.display = 'none';
            document.getElementById('tableEmpty').style.display = 'block';
            document.getElementById('tableEmpty').innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>加载密钥池数据失败，请检查网络连接或刷新页面
            `;
        });
}

// 保存Session
function saveSession() {
    const sessionInput = document.getElementById('sessionInput');
    const sessionValue = sessionInput.value.trim();
    const saveBtn = document.getElementById('saveSessionBtn');
    const saveBtnText = document.getElementById('saveBtnText');
    const saveBtnSpinner = document.getElementById('saveBtnSpinner');
    const sessionSaveMsg = document.getElementById('sessionSaveMsg');
    
    // 验证输入
    if (!sessionValue) {
        sessionSaveMsg.textContent = 'Session 不能为空！';
        sessionSaveMsg.className = 'alert alert-danger mt-2';
        sessionSaveMsg.style.display = 'block';
        sessionInput.focus();
        return;
    }
    
    // 显示加载状态
    saveBtn.disabled = true;
    saveBtnText.textContent = '保存中...';
    saveBtnSpinner.classList.remove('d-none');
    sessionSaveMsg.style.display = 'none';
    
    // 发送请求
    fetch('/session/set', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_value: sessionValue })
    })
    .then(res => res.json())
    .then(data => {
        // 恢复按钮状态
        saveBtn.disabled = false;
        saveBtnText.textContent = '保存';
        saveBtnSpinner.classList.add('d-none');
        
        // 显示响应消息
        if (data.success) {
            sessionSaveMsg.textContent = data.message || 'Session 已保存并同步到配置文件！';
            sessionSaveMsg.className = 'alert alert-success mt-2';
            sessionSaveMsg.style.display = 'block';
            
            // 重新加载密钥池数据
            setTimeout(loadKeyPool, 1000);
        } else {
            sessionSaveMsg.textContent = data.message || '保存失败！';
            sessionSaveMsg.className = 'alert alert-danger mt-2';
            sessionSaveMsg.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error saving session:', error);
        
        // 恢复按钮状态
        saveBtn.disabled = false;
        saveBtnText.textContent = '保存';
        saveBtnSpinner.classList.add('d-none');
        
        // 显示错误消息
        sessionSaveMsg.textContent = '网络错误，保存失败！';
        sessionSaveMsg.className = 'alert alert-danger mt-2';
        sessionSaveMsg.style.display = 'block';
    });
}

// 切换自动刷新
function toggleAutoRefresh(enabled) {
    if (enabled) {
        // 启动自动刷新
        if (!autoRefreshInterval) {
            autoRefreshInterval = setInterval(loadKeyPool, refreshInterval);
            console.log('Auto refresh enabled, interval:', refreshInterval);
        }
    } else {
        // 停止自动刷新
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            console.log('Auto refresh disabled');
        }
    }
}

// 事件监听器
document.addEventListener('DOMContentLoaded', function() {
    // 初始加载密钥池数据
    loadKeyPool();
    
    // 保存按钮点击事件
    document.getElementById('saveSessionBtn').addEventListener('click', saveSession);
    
    // 刷新按钮点击事件
    document.getElementById('refreshBtn').addEventListener('click', function() {
        this.classList.add('rotate-animation');
        loadKeyPool();
        setTimeout(() => {
            this.classList.remove('rotate-animation');
        }, 1000);
    });
    
    // 自动刷新开关
    document.getElementById('autoRefreshSwitch').addEventListener('change', function() {
        toggleAutoRefresh(this.checked);
    });
    
    // Enter键提交
    document.getElementById('sessionInput').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            saveSession();
        }
    });
});

// 页面卸载时清理定时器
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>

<style>
/* 旋转动画 */
@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.rotate-animation {
    animation: rotate 1s linear;
}

/* 表格样式 */
#keyPoolTable code {
    font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.9em;
    background-color: #f8f9fa;
    padding: 0.2em 0.4em;
    border-radius: 3px;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .card-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .card-header > div {
        margin-top: 0.5rem;
    }
}
</style>
{% endblock %} 