{% extends 'base.html' %}
{% block title %}模型供应商管理{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">首页</a></li>
        <li class="breadcrumb-item active" aria-current="page">模型供应商管理</li>
      </ol>
    </nav>
    <div class="row">
        <div class="col-md-12">
            <div class="card settings-card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h5 class="card-title mb-0">模型供应商管理</h5>
                    </div>
                    <button type="button" class="btn btn-light" id="addProviderBtn"><i class="bi bi-plus"></i> 添加供应商</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>名称</th>
                                    <th>默认模型</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="providersTableBody">
                                {% for provider in providers %}
                                <tr data-provider-id="{{ provider.provider_id|string }}" 
    data-api-key="{{ provider.api_key|default('') }}" 
    data-api-base="{{ provider.api_base|default('') }}" 
    data-models="{{ provider.models|default('') }}" 
    class="{% if provider.provider_id == default_provider %}table-primary{% endif %}">
                                    <td>{{ provider.provider_id }}</td>
                                    <td>{{ provider.name }}</td>
                                    <td>{{ provider.default_model }}</td>
                                    <td>
                                        <span class="badge {% if provider.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if provider.is_active %}激活{% else %}禁用{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-info provider-detail-btn" data-provider-id="{{ provider.provider_id|string }}">详情</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary edit-provider-btn" data-provider-id="{{ provider.provider_id|string }}">编辑</button>
                                        {% if provider.provider_id == default_provider %}
                                        <span class="badge bg-info ms-1">默认</span>
                                        {% else %}
                                        <button type="button" class="btn btn-sm btn-outline-success set-default-btn" data-provider-id="{{ provider.provider_id|string }}">设为默认</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑/添加供应商模态框 -->
    <div class="modal fade" id="providerModal" tabindex="-1" aria-labelledby="providerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="providerModalLabel">编辑供应商</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="providerForm" class="needs-validation" onsubmit="event.preventDefault();">
    <div class="text-danger mb-2" id="providerFormError"></div>
                        <input type="hidden" id="provider_id" name="provider_id">
                        <div class="mb-3">
                            <label for="provider_name" class="form-label">供应商名称</label>
                            <input type="text" class="form-control" id="provider_name" name="name" required autocomplete="username">
                        </div>
                        <div class="mb-3">
                            <label for="provider_type" class="form-label">供应商类型</label>
                            <select class="form-select" id="provider_type" name="type" required>
                                <option value="fal2">Fal2</option>
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="xfyun">讯飞</option>
                                <option value="custom">自定义</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="provider_api_key" class="form-label">API密钥</label>
                            <input type="password" class="form-control" id="provider_api_key" name="api_key" required autocomplete="current-password">
                        </div>
                        <div class="mb-3">
                            <label for="provider_api_base" class="form-label">API基础URL</label>
                            <input type="text" class="form-control" id="provider_api_base" name="api_base" required>
                        </div>
                        <div class="mb-3">
                            <label for="provider_models" class="form-label">可用模型列表</label>
                            <input type="text" class="form-control" id="provider_models" name="models" placeholder="模型名称，用逗号分隔" required>
                            <small class="form-text text-muted">多个模型用逗号分隔，例如：gpt-4o,gpt-3.5-turbo<br>
<span id="fal2ModelHint" style="display:none; color:#0d6efd;">Fal2 推荐模型：gpt-4-vision-preview, flux-1.1-pro-ultra, flux.1-pro-new, flux-1.1-ultra, flux-1.1-pro, dall-e-3, recraft-v3, ideogram, ideogram-v2, hidream-i1-full</span>
</small>
                        </div>
                        <div class="mb-3">
                            <label for="provider_default_model" class="form-label">默认模型</label>
                            <select class="form-select" id="provider_default_model" name="default_model" required></select>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="provider_is_active" name="is_active">
                            <label class="form-check-label" for="provider_is_active">激活此供应商</label>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">参数设置</label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="param_temperature" class="form-label">Temperature</label>
                                    <input type="number" class="form-control" id="param_temperature" name="temperature" min="0" max="2" step="0.1" value="0.7">
                                </div>
                                <div class="col-md-6">
                                    <label for="param_max_tokens" class="form-label">Max Tokens</label>
                                    <input type="number" class="form-control" id="param_max_tokens" name="max_tokens" min="1" max="8000" value="500">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveProviderBtn" form="providerForm">保存</button>
                </div>
            </div>
        </div>
    </div>
<!-- 供应商详情模态框 -->
<div class="modal fade" id="providerDetailModal" tabindex="-1" aria-labelledby="providerDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="providerDetailModalLabel">供应商详情</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="providerDetailForm">
          <input type="hidden" name="provider_id" id="detail_provider_id">
          <div class="mb-3">
            <label class="form-label">API密钥</label>
            <input type="password" class="form-control" id="detail_api_key" name="api_key">
          </div>
          <div class="mb-3">
  <label class="form-label">API地址</label>
  <div class="input-group">
    <input type="text" class="form-control" id="detail_api_base" name="api_base">
    <button class="btn btn-outline-secondary" type="button" id="detectModelsBtn">检测模型</button>
  </div>
</div>
          <div class="mb-3">
            <label class="form-label">模型列表</label>
            <input type="text" class="form-control" id="detail_models" name="models">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-primary" id="saveProviderDetailBtn">保存</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // 详情按钮逻辑
    document.querySelectorAll('.provider-detail-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var tr = btn.closest('tr');
        document.getElementById('detail_provider_id').value = tr.dataset.providerId || '';
        document.getElementById('detail_api_key').value = tr.getAttribute('data-api-key') || '';
        document.getElementById('detail_api_base').value = tr.getAttribute('data-api-base') || '';
        document.getElementById('detail_models').value = tr.getAttribute('data-models') || '';
        var modal = new bootstrap.Modal(document.getElementById('providerDetailModal'));
        modal.show();
      });
    });
    // 保存按钮逻辑
    document.getElementById('saveProviderDetailBtn').addEventListener('click', function() {
      var providerId = document.getElementById('detail_provider_id').value.trim();
      var data = {
        api_key: document.getElementById('detail_api_key').value.trim(),
        api_base: document.getElementById('detail_api_base').value.trim(),
        models: document.getElementById('detail_models').value.trim()
        // 可扩展其他字段，如 name、default_model 等
      };
      var url = '/api/model_providers' + (providerId ? '/' + providerId : '');
      var method = providerId ? 'PUT' : 'POST';
      fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert(data.message || '保存失败');
        }
      })
      .catch(() => {
        alert('请求失败');
      });
    });
    // 检测模型按钮逻辑
    document.getElementById('detectModelsBtn').addEventListener('click', function() {
      var apiBase = document.getElementById('detail_api_base').value.trim();
      var apiKey = document.getElementById('detail_api_key').value.trim();
      if (!apiBase) {
        alert('请先填写API地址'); return;
      }
      var url = apiBase.replace(/\/$/, '') + '/v1/models';
      fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': apiKey ? ('Bearer ' + apiKey) : '',
          'Content-Type': 'application/json'
        }
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.data && Array.isArray(data.data)) {
          var models = data.data.map(m => m.id || m.name || '').filter(Boolean).join(', ');
          document.getElementById('detail_models').value = models;
          alert('检测成功，已填入模型列表！');
        } else if (data.models && Array.isArray(data.models)) {
          // fal2等兼容API
          var models = data.models.map(m => m.id || m.name || '').filter(Boolean).join(', ');
          document.getElementById('detail_models').value = models;
          alert('检测成功，已填入模型列表！');
        } else {
          alert('未检测到模型列表，请检查API兼容性！');
        }
      })
      .catch(() => {
        alert('检测失败，请检查API地址和密钥是否正确！');
      });
    });
});
</script>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // 显示添加供应商模态框
    document.getElementById('addProviderBtn').addEventListener('click', function () {
        document.getElementById('providerForm').reset();
        document.getElementById('provider_id').value = '';
        document.getElementById('providerModalLabel').textContent = '添加供应商';
        document.getElementById('providerFormError').textContent = '';
        var modal = new bootstrap.Modal(document.getElementById('providerModal'));
        modal.show();
    });

    // 更新默认模型下拉列表
    function updateDefaultModelOptions(modelsInputValue) {
        var defaultModelSelect = document.getElementById('provider_default_model');
        defaultModelSelect.innerHTML = '';
        if (modelsInputValue) {
            var models = modelsInputValue.split(',').map(model => model.trim()).filter(model => model);
            models.forEach(model => {
                var option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                defaultModelSelect.appendChild(option);
            });
        } else {
            var option = document.createElement('option');
            option.value = '';
            option.textContent = '请先输入模型列表';
            defaultModelSelect.appendChild(option);
        }
    }
    
    // 监听模型列表输入变化
    document.getElementById('provider_models').addEventListener('input', function() {
        updateDefaultModelOptions(this.value);
    });
    
    // 显示模态框时更新默认模型选项
    document.getElementById('addProviderBtn').addEventListener('click', function () {
        document.getElementById('providerForm').reset();
        document.getElementById('provider_id').value = '';
        document.getElementById('providerModalLabel').textContent = '添加供应商';
        document.getElementById('providerFormError').textContent = '';
        updateDefaultModelOptions('');
        var modal = new bootstrap.Modal(document.getElementById('providerModal'));
        modal.show();
    });

    // 编辑按钮事件
    document.querySelectorAll('.edit-provider-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            var tr = btn.closest('tr');
            document.getElementById('provider_id').value = tr.dataset.providerId || '';
            document.getElementById('provider_name').value = tr.children[1].textContent.trim();
            document.getElementById('provider_api_key').value = '';
            document.getElementById('provider_models').value = tr.getAttribute('data-models') || '';
            document.getElementById('provider_default_model').value = tr.children[2].textContent.trim();
            document.getElementById('providerModalLabel').textContent = '编辑供应商';
            document.getElementById('providerFormError').textContent = '';
            updateDefaultModelOptions(tr.getAttribute('data-models') || '');
            var modal = new bootstrap.Modal(document.getElementById('providerModal'));
            modal.show();
        });
    });

    // 表单提交
    document.getElementById('providerForm').addEventListener('submit', function (e) {
        e.preventDefault();
        var form = this;
        var submitBtn = form.querySelector('button[type=submit]');
        submitBtn && (submitBtn.disabled = true);
        submitBtn && (submitBtn.innerHTML = '提交中...');
        document.getElementById('providerFormError').textContent = '';
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            submitBtn && (submitBtn.disabled = false);
            submitBtn && (submitBtn.innerHTML = '保存');
            return;
        }
        var formData = new FormData(form);
        var data = Object.fromEntries(formData);
        // 转换 is_active 为布尔值
        data.is_active = data.is_active === 'on';
        // 转换 temperature 和 max_tokens 为数字
        data.temperature = parseFloat(data.temperature);
        data.max_tokens = parseInt(data.max_tokens);
        var providerId = document.getElementById('provider_id').value;
        var url = '/api/model_providers' + (providerId ? '/' + providerId : '');
        var method = providerId ? 'PUT' : 'POST';
        console.log('Submitting to:', url, 'Method:', method, 'Data:', data);
        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
          .then(data => {
              console.log('Response data:', data);
              if (data.success) {
                  location.reload();
              } else {
                  document.getElementById('providerFormError').textContent = data.message || '操作失败';
              }
          })
          .catch(error => {
              console.error('Fetch error:', error);
              document.getElementById('providerFormError').textContent = '请求失败: ' + error.message;
          })
          .finally(() => {
              submitBtn && (submitBtn.disabled = false);
              submitBtn && (submitBtn.innerHTML = '保存');
          });
    });
});
    // 类型切换时显示 fal2 推荐模型
    document.getElementById('provider_type')?.addEventListener('change', function () {
        var v = this.value;
        var hint = document.getElementById('fal2ModelHint');
        if (hint) {
            if (v === 'fal2') {
                hint.style.display = '';
            } else {
                hint.style.display = 'none';
            }
        }
    });
    // 初始化时根据类型显示/隐藏提示
    document.getElementById('provider_type')?.dispatchEvent(new Event('change'));
</script>
{% endblock %}
