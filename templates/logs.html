{% extends 'base.html' %}
{% block title %}EduBrain AI - 系统日志{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">系统日志</h5>
                </div>
                <div class="card-body p-0">
                    <div class="log-toolbar">
                        <div>
                            <button id="refreshBtn" class="btn btn-sm btn-primary">
                                <i class="bi bi-arrow-clockwise"></i> 刷新日志
                            </button>
                            <button id="clearViewBtn" class="btn btn-sm btn-secondary">
                                <i class="bi bi-x-circle"></i> 清空视图
                            </button>
                            <button id="downloadBtn" class="btn btn-sm btn-info">
                                <i class="bi bi-download"></i> 下载日志
                            </button>
                        </div>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="showErrorCheck" checked>
                                <label class="form-check-label" for="showErrorCheck">错误</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="showWarningCheck" checked>
                                <label class="form-check-label" for="showWarningCheck">警告</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="showInfoCheck" checked>
                                <label class="form-check-label" for="showInfoCheck">信息</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="showDebugCheck" checked>
                                <label class="form-check-label" for="showDebugCheck">调试</label>
                            </div>
                        </div>
                    </div>
                    <div id="logView" class="log-container">{{ log_content|safe }}</div>
                </div>
            </div>
        </div>
    </div>
</div>
<footer class="footer mt-5 py-3 bg-light">
    <div class="container text-center">
        <p>EduBrain AI - 智能题库系统 v{{ version }}</p>
        <p>Powered by OpenAI API | 作者：LynnGuo666</p>
        <p><small>© 2024-2025 All Rights Reserved</small></p>
    </div>
</footer>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script>
$(document).ready(function() {
    highlightLogs();
    scrollToBottom();
    
    // 刷新按钮
    $('#refreshBtn').click(function() { 
        location.reload(); 
    });
    
    // 删除自动刷新功能，改为手动刷新
    // setInterval(function() { location.reload(); }, 5000);
    
    // 清空视图按钮
    $('#clearViewBtn').click(function() { 
        $('#logView').empty(); 
    });
    
    // 下载按钮
    $('#downloadBtn').click(function() {
        const logContent = $('#logView').text();
        const blob = new Blob([logContent], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'ai_service_log_' + new Date().toISOString().slice(0, 10) + '.txt';
        link.click();
        URL.revokeObjectURL(link.href);
    });
    
    // 过滤日志复选框
    $('#showErrorCheck, #showWarningCheck, #showInfoCheck, #showDebugCheck').change(function() { 
        filterLogs(); 
    });
});

// 高亮不同级别的日志
function highlightLogs() {
    const logView = document.getElementById('logView');
    let content = logView.innerHTML;
    content = content.replace(/\b(ERROR)\b.*$/gm, '<span class="log-error">$&</span>');
    content = content.replace(/\b(WARNING)\b.*$/gm, '<span class="log-warning">$&</span>');
    content = content.replace(/\b(INFO)\b.*$/gm, '<span class="log-info">$&</span>');
    content = content.replace(/\b(DEBUG)\b.*$/gm, '<span class="log-debug">$&</span>');
    logView.innerHTML = content;
}

// 根据复选框状态过滤日志
function filterLogs() {
    const showError = $('#showErrorCheck').is(':checked');
    const showWarning = $('#showWarningCheck').is(':checked');
    const showInfo = $('#showInfoCheck').is(':checked');
    const showDebug = $('#showDebugCheck').is(':checked');
    
    $('.log-error').toggle(showError);
    $('.log-warning').toggle(showWarning);
    $('.log-info').toggle(showInfo);
    $('.log-debug').toggle(showDebug);
}

// 滚动到日志底部
function scrollToBottom() {
    const logView = document.getElementById('logView');
    logView.scrollTop = logView.scrollHeight;
}
</script>
{% endblock %} 