{% extends 'base.html' %}
{% block title %}EduBrain AI - 题库管理{% endblock %}

{% block head %}
<style>
    /* 现代化卡片样式 */
    .stat-card {
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        border: none;
        height: 100%;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    
    .stat-card .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        background: rgba(255,255,255,0.2);
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
    }
    
    .stat-card .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }
    
    .stat-card .stat-label {
        font-size: 1rem;
        opacity: 0.8;
    }
    
    .stat-card::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        transform: translate(30%, 30%);
    }
    
    .stat-card.primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
    }
    
    .stat-card.success {
        background: linear-gradient(135deg, #28a745, #1e7e34);
        color: white;
    }
    
    .stat-card.info {
        background: linear-gradient(135deg, #17a2b8, #117a8b);
        color: white;
    }
    
    .stat-card.warning {
        background: linear-gradient(135deg, #ffc107, #d39e00);
        color: white;
    }
    
    /* 表格和卡片样式 */
    .dashboard-card {
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        border: none;
        margin-bottom: 1.5rem;
    }
    
    .dashboard-card:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    
    .card-header {
        border-radius: 10px 10px 0 0 !important;
        font-weight: 500;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0,123,255,0.05);
    }
    
    .btn-action {
        border-radius: 50px;
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
        transition: all 0.2s;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
    }
    
    /* 批量操作按钮样式 */
    .batch-actions {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
    }
    
    .selected-badge {
        background: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
        border-radius: 50px;
        padding: 0.25rem 0.75rem;
        font-weight: 500;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 0.8; }
        50% { opacity: 1; }
        100% { opacity: 0.8; }
    }
</style>
<script>
// 图片处理代码已移除
</script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- 统计卡片 -->
    <div class="row">
        <div class="col-md-4">
            <div class="stat-card primary">
                <div class="stat-icon">
                    <i class="bi bi-journal-richtext"></i>
                </div>
                <div class="stat-value">{{ type_counts.all }}</div>
                <div class="stat-label">题目总数</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card success">
                <div class="stat-icon">
                    <i class="bi bi-ui-checks"></i>
                </div>
                <div class="stat-value">{{ type_counts.single + type_counts.multiple }}</div>
                <div class="stat-label">选择题数量</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card info">
                <div class="stat-icon">
                    <i class="bi bi-patch-question"></i>
                </div>
                <div class="stat-value">{{ type_counts.judgement + type_counts.completion }}</div>
                <div class="stat-label">判断/填空题</div>
            </div>
        </div>
    </div>
    <!-- 搜索和筛选 -->
    <div class="card dashboard-card mt-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0"><i class="bi bi-database me-2"></i>题库管理</h5>
            <div>
                <button class="btn btn-success btn-sm me-1" data-bs-toggle="modal" data-bs-target="#importModal">
                    <i class="bi bi-upload"></i> 导入
                </button>
                <a href="{{ url_for('questions.export_questions') }}" class="btn btn-info btn-sm">
                    <i class="bi bi-download"></i> 导出
                </a>
            </div>
        </div>
        <div class="card-body">
            <!-- 过滤和搜索表单 -->
            <form id="searchForm" action="{{ url_for('questions.questions') }}" method="GET" class="mb-4">
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" name="q" placeholder="搜索题目或答案..." value="{{ search_query }}">
                            <button class="btn btn-outline-primary" type="submit">搜索</button>
                            {% if search_query %}
                            <a href="{{ url_for('questions.questions') }}" class="btn btn-outline-secondary">清除</a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex flex-column">
                            <div class="btn-group mb-2" role="group">
                                <a href="{{ url_for('questions.questions') }}" class="btn btn-outline-primary {% if not current_type %}active{% endif %}">
                                    全部 ({{ type_counts.all }})
                                </a>
                                <a href="{{ url_for('questions.questions', type='single') }}" class="btn btn-outline-primary {% if current_type == 'single' %}active{% endif %}">
                                    单选题 ({{ type_counts.single }})
                                </a>
                                <a href="{{ url_for('questions.questions', type='multiple') }}" class="btn btn-outline-primary {% if current_type == 'multiple' %}active{% endif %}">
                                    多选题 ({{ type_counts.multiple }})
                                </a>
                                <a href="{{ url_for('questions.questions', type='judgement') }}" class="btn btn-outline-primary {% if current_type == 'judgement' %}active{% endif %}">
                                    判断题 ({{ type_counts.judgement }})
                                </a>
                                <a href="{{ url_for('questions.questions', type='completion') }}" class="btn btn-outline-primary {% if current_type == 'completion' %}active{% endif %}">
                                    填空题 ({{ type_counts.completion }})
                                </a>
                            </div>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('questions.questions', type='short') }}" class="btn btn-outline-primary {% if current_type == 'short' %}active{% endif %}">
                                    简答题 ({{ type_counts.short }})
                                </a>
                                <a href="{{ url_for('questions.questions', type='essay') }}" class="btn btn-outline-primary {% if current_type == 'essay' %}active{% endif %}">
                                    论述题 ({{ type_counts.essay }})
                                </a>
                                <a href="{{ url_for('questions.questions', type='calculation') }}" class="btn btn-outline-primary {% if current_type == 'calculation' %}active{% endif %}">
                                    计算题 ({{ type_counts.calculation }})
                                </a>
                                <a href="{{ url_for('questions.questions', type='analysis') }}" class="btn btn-outline-primary {% if current_type == 'analysis' %}active{% endif %}">
                                    分析题 ({{ type_counts.analysis }})
                                </a>
                                <a href="{{ url_for('questions.questions', type='case') }}" class="btn btn-outline-primary {% if current_type == 'case' %}active{% endif %}">
                                    案例题 ({{ type_counts.case }})
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <!-- 批量操作 -->
            <div class="batch-actions mb-3 d-flex align-items-center justify-content-between">
                <div>
                    <button id="batchDeleteBtn" class="btn btn-danger btn-action" disabled>
                        <i class="bi bi-trash"></i> 批量删除
                    </button>
                    <span id="selectedCount" class="ms-2 d-none selected-badge">已选择 <span id="selectedNumber">0</span> 条记录</span>
                </div>
                <div>
                    <button class="btn btn-outline-primary btn-action" id="refreshBtn">
                        <i class="bi bi-arrow-repeat"></i> 刷新数据
                    </button>
                </div>
            </div>
            <!-- 题库表格 -->
            <div class="table-responsive">
                <table id="question-table" class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            <th>ID</th>
                            <th>类型</th>
                            <th>问题</th>
                            <th>答案</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                        <tr>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input record-checkbox" type="checkbox" value="{{ record.id }}">
                                </div>
                            </td>
                            <td>{{ record.id }}</td>
                            <td>
                                {% if record.type == 'single' %}
                                    <span class="badge bg-success">单选题</span>
                                {% elif record.type == 'multiple' %}
                                    <span class="badge bg-primary">多选题</span>
                                {% elif record.type == 'judgement' %}
                                    <span class="badge bg-warning">判断题</span>
                                {% elif record.type == 'completion' %}
                                    <span class="badge bg-info">填空题</span>
                                {% elif record.type == 'short' %}
                                    <span class="badge bg-dark">简答题</span>
                                {% elif record.type == 'essay' %}
                                    <span class="badge bg-secondary">论述题</span>
                                {% elif record.type == 'calculation' %}
                                    <span class="badge bg-danger">计算题</span>
                                {% elif record.type == 'analysis' %}
                                    <span class="badge bg-light text-dark">分析题</span>
                                {% elif record.type == 'case' %}
                                    <span class="badge bg-primary" style="background-color: #6f42c1 !important;">案例题</span>
                                {% elif record.type == 'matching' %}
                                    <span class="badge bg-info" style="background-color: #20c997 !important;">匹配题</span>
                                {% else %}
                                    <span class="badge bg-secondary">未知</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="question-content" style="max-width: 300px; max-height: 100px; overflow: auto;" title="{{ record.question }}">
                                    {{ record.question|safe }}
                                </div>
                            </td>
                            <td>
                                <div class="answer-content" style="max-width: 200px; max-height: 100px; overflow: auto;" title="{{ record.answer }}">
                                    {{ record.answer|safe }}
                                </div>
                            </td>
                            <td>{{ record.time }}</td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-info btn-action" data-bs-toggle="modal" data-bs-target="#detailModal{{ loop.index }}" aria-label="查看详情">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning btn-action" data-bs-toggle="modal" data-bs-target="#editModal{{ loop.index }}" aria-label="编辑题目">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger btn-action delete-record" data-record-id="{{ record.id }}" aria-label="删除题目">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- 详情模态框 -->
                        <div class="modal fade" id="detailModal{{ loop.index }}" tabindex="-1" aria-labelledby="detailModalLabel{{ loop.index }}">
                            <div class="modal-dialog modal-lg modal-dialog-centered">
                                <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title" id="detailModalLabel{{ loop.index }}"><i class="bi bi-info-circle me-2"></i>题目详情</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <h6>ID:</h6>
                                            <p>{{ record.id }}</p>
                                        </div>
                                        <div class="mb-3">
                                            <h6>问题类型:</h6>
                                            <p>
                                                {% if record.type == 'single' %}
                                                    <span class="badge bg-success">单选题</span>
                                                {% elif record.type == 'multiple' %}
                                                    <span class="badge bg-primary">多选题</span>
                                                {% elif record.type == 'judgement' %}
                                                    <span class="badge bg-warning">判断题</span>
                                                {% elif record.type == 'completion' %}
                                                    <span class="badge bg-info">填空题</span>
                                                {% elif record.type == 'short' %}
                                                    <span class="badge bg-dark">简答题</span>
                                                {% elif record.type == 'essay' %}
                                                    <span class="badge bg-secondary">论述题</span>
                                                {% elif record.type == 'calculation' %}
                                                    <span class="badge bg-danger">计算题</span>
                                                {% elif record.type == 'analysis' %}
                                                    <span class="badge bg-light text-dark">分析题</span>
                                                {% elif record.type == 'case' %}
                                                    <span class="badge bg-primary" style="background-color: #6f42c1 !important;">案例题</span>
                                                {% elif record.type == 'matching' %}
                                                    <span class="badge bg-info" style="background-color: #20c997 !important;">匹配题</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">未知</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                        <div class="mb-3">
                                            <h6 class="text-primary"><i class="bi bi-question-circle me-2"></i>问题内容:</h6>
                                            <div class="border rounded p-3 bg-light shadow-sm">{{ record.question }}</div>
                                        </div>
                                        {% if record.options %}
                                        <div class="mb-3">
                                            <h6 class="text-success"><i class="bi bi-list-check me-2"></i>选项:</h6>
                                            <div class="border rounded p-3 bg-light shadow-sm">{{ record.options }}</div>
                                        </div>
                                        {% endif %}
                                        <div class="mb-3">
                                            <h6 class="text-danger"><i class="bi bi-check2-circle me-2"></i>答案:</h6>
                                            <div class="border rounded p-3 bg-light shadow-sm">{{ record.answer }}</div>
                                        </div>
                                        <div class="mb-3">
                                            <h6>创建时间:</h6>
                                            <p>{{ record.time }}</p>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                            <i class="bi bi-x-circle me-1"></i>关闭
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 编辑模态框 -->
                        <div class="modal fade" id="editModal{{ loop.index }}" tabindex="-1" aria-labelledby="editModalLabel{{ loop.index }}">
                            <div class="modal-dialog modal-lg modal-dialog-centered">
                                <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
                                    <div class="modal-header bg-warning">
                                        <h5 class="modal-title" id="editModalLabel{{ loop.index }}"><i class="bi bi-pencil-square me-2"></i>编辑题目</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="editForm{{ loop.index }}" onsubmit="return false;">
                                            <input type="hidden" name="record_id" value="{{ record.id }}">
                                            
                                            <div class="mb-3">
                                                <label for="edit-type-{{ loop.index }}" class="form-label">问题类型:</label>
                                                <select class="form-select" id="edit-type-{{ loop.index }}" name="type">
                                                    <option value="" {% if not record.type %}selected{% endif %}>未知</option>
                                                    <option value="single" {% if record.type == 'single' %}selected{% endif %}>单选题</option>
                                                    <option value="multiple" {% if record.type == 'multiple' %}selected{% endif %}>多选题</option>
                                                    <option value="judgement" {% if record.type == 'judgement' %}selected{% endif %}>判断题</option>
                                                    <option value="completion" {% if record.type == 'completion' %}selected{% endif %}>填空题</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="edit-question-{{ loop.index }}" class="form-label">问题内容:</label>
                                                <textarea class="form-control" id="edit-question-{{ loop.index }}" name="question" rows="3">{{ record.question }}</textarea>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="edit-options-{{ loop.index }}" class="form-label">选项内容:</label>
                                                <textarea class="form-control" id="edit-options-{{ loop.index }}" name="options" rows="3">{{ record.options }}</textarea>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="edit-answer-{{ loop.index }}" class="form-label">答案:</label>
                                                <textarea class="form-control" id="edit-answer-{{ loop.index }}" name="answer" rows="2">{{ record.answer }}</textarea>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                            <i class="bi bi-x-circle me-1"></i>取消
                                        </button>
                                        <button type="button" class="btn btn-primary save-edit" data-form-id="editForm{{ loop.index }}">
                                            <i class="bi bi-check-circle me-1"></i>保存
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- 分页 -->
            {% if total_pages > 1 %}
            <nav aria-label="分页导航">
                <ul class="pagination justify-content-center">
                    <li class="page-item {% if page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('questions.questions', page=page-1, per_page=per_page, q=search_query, type=current_type) }}">上一页</a>
                    </li>
                    
                    {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                            <li class="page-item active">
                                <span class="page-link">{{ p }}</span>
                            </li>
                        {% elif p >= page - 2 and p <= page + 2 %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('questions.questions', page=p, per_page=per_page, q=search_query, type=current_type) }}">{{ p }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('questions.questions', page=page+1, per_page=per_page, q=search_query, type=current_type) }}">下一页</a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- 导入模态框 -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="importModalLabel">导入题库</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="importFile" class="form-label">选择CSV文件:</label>
                        <input type="file" class="form-control" id="importFile" name="file" accept=".csv" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-text">
                            <p>CSV文件格式要求:</p>
                            <ul>
                                <li>第一行必须是标题行: ID,问题,类型,选项,答案,创建时间</li>
                                <li>类型列可以填写: 单选题,多选题,判断题,填空题,未知</li>
                                <li>文件编码必须是UTF-8</li>
                            </ul>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" id="importButton">导入</button>
            </div>
        </div>
    </div>
</div>

<!-- 批量删除确认模态框 -->
<div class="modal fade" id="batchDeleteModal" tabindex="-1" aria-labelledby="batchDeleteModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="batchDeleteModalLabel">确认批量删除</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除选中的 <span id="deleteCount">0</span> 条记录吗？此操作不可撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmBatchDelete">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 单条记录删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">确认删除</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除这条记录吗？此操作不可撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 操作结果提示模态框 -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalLabel">操作结果</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="resultMessage">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
            </div>
        </div>
    </div>
</div>

<!-- 错误模板页面 -->
{% if error %}
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" data-has-error="true">
{% else %}
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" data-has-error="false">
{% endif %}
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="errorModalLabel">错误</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {{ error }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
            </div>
        </div>
    </div>
</div>

<!-- 导入成功模态框 -->
<div class="modal fade" id="importSuccessModal" tabindex="-1" aria-hidden="true">
    <!-- ... 模态框内容 ... -->
</div>

<footer class="footer mt-5 py-3 bg-light">
    <div class="container text-center">
        <p class="text-muted">Copyright &copy; {{ current_year }} EduBrain AI. All rights reserved.</p>
    </div>
</footer>

<script>
    {{ super() }}
    $(document).ready(function() {
        // 页面加载完成后隐藏可能存在的加载动画
        hideLoading();
        
        // 初始化DataTable
        $('#question-table').DataTable({
            responsive: true,
            paging: false,
            searching: false,
            info: false,
            language: {
                emptyTable: "没有找到记录",
                zeroRecords: "没有找到匹配的记录"
            }
        });
        
        // 如果有错误，显示错误模态框
        if ($('#errorModal').data('has-error') === true) {
            var errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
            errorModal.show();
        }
        
        // 刷新按钮点击事件
        $('#refreshBtn').on('click', function() {
            showLoading();
            window.location.reload();
        });
        
        // 为所有表单添加验证
        $('form').each(function() {
            $(this).on('submit', function(e) {
                if (!this.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                } else {
                    showLoading();
                }
                $(this).addClass('was-validated');
            });
        });
        
        // 编辑表单提交处理
        $(document).on('click', '.save-edit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const formId = $(this).data('form-id');
            const form = $('#' + formId)[0];
            
            // 表单验证
            if (!form.checkValidity()) {
                $(form).addClass('was-validated');
                return;
            }
            
            // 显示加载动画
            showLoading();
            
            const recordId = form.querySelector('[name="record_id"]').value;
            const question = form.querySelector('[name="question"]').value;
            const type = form.querySelector('[name="type"]').value;
            const options = form.querySelector('[name="options"]').value;
            const answer = form.querySelector('[name="answer"]').value;
            const data = { record_id: recordId, question, type, options, answer };
            
            // 关闭模态框
            const modal = $(this).closest('.modal');
            modal.modal('hide');
            
            // 发送AJAX请求
            $.ajax({
                url: '/api/record/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                beforeSend: function() {
                    showLoading();
                },
                complete: function() {
                    hideLoading();
                },
                error: function(xhr, status, error) {
                    hideLoading();
                    $('#resultMessage').html('<div class="alert alert-danger">更新失败: ' + error + '</div>');
                    var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                    resultModal.show();
                },

                success: function(response) {
                    $('#resultMessage').text(response.message);
                    var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                    resultModal.show();
                    if (response.success) {
                        $('#resultModal').on('hidden.bs.modal', function() {
                            location.reload();
                        });
                    }
                },
                error: function(xhr) {
                    let errorMessage = '更新失败';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.message || errorMessage;
                    } catch (e) {}
                    $('#resultMessage').text(errorMessage);
                    var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                    resultModal.show();
                }
            });
        });
        
        // 单条记录删除
        let deleteRecordId = null;
        $('.delete-record').click(function() {
            deleteRecordId = $(this).data('record-id');
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        });
        
        $('#confirmDelete').click(function() {
            if (deleteRecordId) {
                $.ajax({
                    url: '/api/record/delete',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        record_id: deleteRecordId
                    }),
                    success: function(response) {
                        // 关闭删除确认框
                        $('#deleteModal').modal('hide');
                        
                        // 显示结果
                        $('#resultMessage').text(response.message);
                        var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                        resultModal.show();
                        
                        // 成功后刷新页面
                        if (response.success) {
                            $('#resultModal').on('hidden.bs.modal', function() {
                                location.reload();
                            });
                        }
                    },
                    error: function(xhr) {
                        // 关闭删除确认框
                        $('#deleteModal').modal('hide');
                        
                        // 显示错误
                        let errorMessage = '删除失败';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMessage = response.message || errorMessage;
                        } catch (e) {}
                        
                        $('#resultMessage').text(errorMessage);
                        var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                        resultModal.show();
                    }
                });
            }
        });
        
        // 批量删除
        $('#selectAll').on('change', function() {
            $('.record-checkbox').prop('checked', $(this).prop('checked'));
            updateSelectedCount();
        });
        
        $('.record-checkbox').on('change', function() {
            updateSelectedCount();
            
            // 如果不是所有的都被选中，取消全选框的选中状态
            if ($('.record-checkbox:checked').length !== $('.record-checkbox').length) {
                $('#selectAll').prop('checked', false);
            } else if ($('.record-checkbox:checked').length === $('.record-checkbox').length) {
                $('#selectAll').prop('checked', true);
            }
        });
        
        function updateSelectedCount() {
            const selectedCount = $('.record-checkbox:checked').length;
            $('#selectedNumber').text(selectedCount);
            
            if (selectedCount > 0) {
                $('#selectedCount').removeClass('d-none');
                $('#batchDeleteBtn').prop('disabled', false);
            } else {
                $('#selectedCount').addClass('d-none');
                $('#batchDeleteBtn').prop('disabled', true);
            }
        }
        
        $('#batchDeleteBtn').on('click', function() {
            const selectedCount = $('.record-checkbox:checked').length;
            $('#deleteCount').text(selectedCount);
            
            var batchDeleteModal = new bootstrap.Modal(document.getElementById('batchDeleteModal'));
            batchDeleteModal.show();
        });
        
        $('#confirmBatchDelete').on('click', function() {
            const selectedIds = [];
            $('.record-checkbox:checked').each(function() {
                selectedIds.push($(this).val());
            });
            
            if (selectedIds.length === 0) return;
            
            showLoading();
            $.ajax({
                url: '/api/record/batch-delete',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ record_ids: selectedIds }),
                success: function(response) {
                    hideLoading();
                    $('#batchDeleteModal').modal('hide');
                    $('#resultMessage').html('<div class="alert alert-' + (response.status === 'success' ? 'success' : 'danger') + '">' + response.message + '</div>');
                    var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                    resultModal.show();
                    if (response.status === 'success') {
                        setTimeout(function() {
                            window.location.reload();
                        }, 1500);
                    }
                },
                error: function(xhr, status, error) {
                    hideLoading();
                    $('#batchDeleteModal').modal('hide');
                    $('#resultMessage').html('<div class="alert alert-danger">批量删除失败: ' + error + '</div>');
                    var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                    resultModal.show();
                }
            });
        });
        
        // 导入题库
        $('#importButton').on('click', function() {
            var fileInput = $('#importFile')[0];
            if (!fileInput.files.length) {
                $('#importFile').addClass('is-invalid');
                return;
            }
            
            var formData = new FormData($('#importForm')[0]);
            showLoading();
            $.ajax({
                url: '/api/questions/import',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    hideLoading();
                    $('#importModal').modal('hide');
                    $('#resultMessage').html('<div class="alert alert-' + (response.status === 'success' ? 'success' : 'danger') + '">' + response.message + '</div>');
                    var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                    resultModal.show();
                    if (response.status === 'success') {
                        setTimeout(function() {
                            window.location.reload();
                        }, 1500);
                    }
                },
                error: function(xhr, status, error) {
                    hideLoading();
                    $('#importModal').modal('hide');
                    $('#resultMessage').html('<div class="alert alert-danger">导入失败: ' + error + '</div>');
                    var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                    resultModal.show();
                }
            });
        });
        
        // 为模态框添加动画效果
        $('.modal').on('show.bs.modal', function() {
            $(this).find('.modal-content').css('transform', 'scale(0.8)');
            setTimeout(() => {
                $(this).find('.modal-content').css('transform', 'scale(1)');
            }, 50);
        });
        
        // 为表单输入添加实时验证
        $('textarea, input').on('input', function() {
            if ($(this).val().trim() === '' && $(this).prop('required')) {
                $(this).removeClass('is-valid').addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid').addClass('is-valid');
            }
        });
        
        // 显示加载动画
        function showLoading() {
            if (!document.getElementById('loadingOverlay')) {
                var loadingHTML = `
                    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; display: flex; justify-content: center; align-items: center;">
                        <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', loadingHTML);
            } else {
                document.getElementById('loadingOverlay').style.display = 'flex';
            }
        }
        
        // 隐藏加载动画
        function hideLoading() {
            var overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        // 页面刷新函数
        function refreshPage() {
            showLoading();
            window.location.reload();
        }
    });
    
    // 题目转圈功能安全修复
    // 为所有与题目转圈相关的按钮添加安全检查
    document.addEventListener('DOMContentLoaded', function() {
        // 查找所有可能与题目转圈相关的按钮
        const rotateButtons = document.querySelectorAll('.rotate-question-btn, .swap-question-btn, [data-action="rotate"]');
        
        if (rotateButtons.length > 0) {
            // 为每个按钮添加安全的点击事件处理
            rotateButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 获取相关元素，添加安全检查
                    const questionId = this.dataset.questionId || this.getAttribute('data-question-id');
                    const targetId = this.dataset.targetId || this.getAttribute('data-target-id');
                    
                    const questionElement = questionId ? document.getElementById(questionId) : null;
                    const targetElement = targetId ? document.getElementById(targetId) : null;
                    
                    // 安全检查：确保元素存在再访问其属性
                    if (!questionElement || !targetElement) {
                        console.error('题目转圈功能：找不到必要的元素');
                        return; // 提前退出函数，防止错误
                    }
                    
                    // 安全地获取值
                    const questionValue = questionElement.value || '';
                    const targetValue = targetElement.value || '';
                    
                    // 执行交换操作
                    try {
                        questionElement.value = targetValue;
                        targetElement.value = questionValue;
                        console.log('题目转圈完成');
                    } catch (error) {
                        console.error('题目转圈操作失败:', error);
                    }
                });
            });
        }
    });
</script>
{% endblock %}